{% extends 'app/base2.html' %}

{% block title %}Team Leader - Attendance Approval{% endblock %}

{% block content %}
<div class="container-fluid"><div class="row"><div class="col-12"><div class="page-title-box d-sm-flex align-items-center justify-content-between"><h4 class="mb-sm-0">Team Leader - Attendance Approval</h4><div class="page-title-right"><ol class="breadcrumb m-0"><li class="breadcrumb-item"><a href="{% url 'tl-dashboard' %}">Dashboard</a></li><li class="breadcrumb-item active">Attendance Approval</li></ol></div></div></div></div><!-- Statistics Cards --><div class="row"><div class="col-xl-3 col-md-6"><div class="card"><div class="card-body"><div class="d-flex"><div class="flex-grow-1"><p class="text-muted mb-2">Pending Approvals</p><h5 class="mb-0">{{ total_pending }}</h5></div><div class="flex-shrink-0"><div class="avatar-sm rounded"><span class="h5 mb-0 text-warning"><i class="ri-time-line"></i></span></div></div></div></div></div></div><div class="col-xl-3 col-md-6"><div class="card"><div class="card-body"><div class="d-flex"><div class="flex-grow-1"><p class="text-muted mb-2">Approved This Month</p><h5 class="mb-0">{{ approved_this_month }}</h5></div><div class="flex-shrink-0"><div class="avatar-sm rounded"><span class="h5 mb-0 text-success"><i class="ri-check-line"></i></span></div></div></div></div></div></div><div class="col-xl-3 col-md-6"><div class="card"><div class="card-body"><div class="d-flex"><div class="flex-grow-1"><p class="text-muted mb-2">Late Arrivals This Month</p><h5 class="mb-0">{{ late_arrivals_this_month }}</h5></div><div class="flex-shrink-0"><div class="avatar-sm rounded"><span class="h5 mb-0 text-danger"><i class="ri-alarm-warning-line"></i></span></div></div></div></div></div></div><div class="col-xl-3 col-md-6"><div class="card"><div class="card-body"><div class="d-flex"><div class="flex-grow-1"><p class="text-muted mb-2">Team Members</p><h5 class="mb-0">{{ tl.teamassignment_set.count }}</h5></div><div class="flex-shrink-0"><div class="avatar-sm rounded"><span class="h5 mb-0 text-primary"><i class="ri-team-line"></i></span></div></div></div></div></div></div></div><div class="row"><div class="col-lg-8"><!-- Pending Attendance Approvals --><div class="card"><div class="card-header"><h5 class="card-title mb-0"><i class="ri-time-line me-2"></i>
                        Pending Attendance Approvals
                    </h5></div><div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
                        {% endfor %}
                    {% endif %}

                    {% if pending_approvals %}
                        <div class="table-responsive"><table class="table table-hover table-nowrap mb-0"><thead class="table-light"><tr><th>Employee</th><th>Date</th><th>Check-in Time</th><th>Status</th><th>Late Details</th><th>Actions</th></tr></thead><tbody>
                                    {% for approval in pending_approvals %}
                                    <tr><td><div class="d-flex align-items-center">
                                                {% if approval.attendance.employee.image %}
                                                    <img src="{{ approval.attendance.employee.image.url }}" alt="{{ approval.attendance.employee.first_name }}" class="avatar-xs rounded-circle me-2">
                                                {% else %}
                                                    <div class="avatar-xs rounded-circle bg-light d-flex align-items-center justify-content-center me-2"><i class="ri-user-line text-muted"></i></div>
                                                {% endif %}
                                                <div><h6 class="mb-0">{{ approval.attendance.employee.first_name }} {{ approval.attendance.employee.last_name }}</h6><small class="text-muted">{{ approval.attendance.employee.company_id }}</small></div></div></td><td>{{ approval.attendance.attendance_date|date:"d M Y" }}</td><td>
                                            {% if approval.attendance.check_in_time %}
                                                {{ approval.attendance.check_in_time|time:"H:i:s" }}
                                            {% else %}
                                                <span class="text-muted">Not recorded</span>
                                            {% endif %}
                                        </td><td>
                                            {% if approval.is_late_arrival %}
                                                <span class="badge bg-warning"><i class="ri-alarm-warning-line me-1"></i>Late Arrival
                                                </span>
                                            {% else %}
                                                <span class="badge bg-info">Regular</span>
                                            {% endif %}
                                        </td><td>
                                            {% if approval.is_late_arrival %}
                                                <small><strong>{{ approval.late_minutes }} min late</strong><br>
                                                    {% if approval.marked_as_half_day %}
                                                        <span class="text-warning">Marked as Half-Day</span>
                                                    {% endif %}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">On time</span>
                                            {% endif %}
                                        </td><td><button type="button" class="btn btn-sm btn-success me-1" data-bs-toggle="modal" data-bs-target="#approveModal{{ approval.id }}"><i class="ri-check-line"></i> Approve
                                            </button><button type="button" class="btn btn-sm btn-danger me-1" data-bs-toggle="modal" data-bs-target="#rejectModal{{ approval.id }}"><i class="ri-close-line"></i> Reject
                                            </button><button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modifyModal{{ approval.id }}"><i class="ri-edit-line"></i> Modify
                                            </button></td></tr>
                                    {% endfor %}
                                </tbody></table></div>
                    {% else %}
                        <div class="text-center py-4"><i class="ri-check-double-line text-success fs-1"></i><h5 class="mt-3 text-muted">All Caught Up!</h5><p class="text-muted">No pending attendance approvals at the moment.</p></div>
                    {% endif %}
                </div></div></div><div class="col-lg-4"><!-- Recent Decisions --><div class="card"><div class="card-header"><h6 class="card-title mb-0"><i class="ri-history-line me-2"></i>
                        Recent Decisions
                    </h6></div><div class="card-body">
                    {% if recent_decisions %}
                        <div class="activity-feed">
                            {% for decision in recent_decisions %}
                            <div class="activity-item d-flex"><div class="flex-shrink-0">
                                    {% if decision.status == 'approved' %}
                                        <div class="avatar-sm rounded"><span class="h-6 mb-0 text-success"><i class="ri-check-line"></i></span></div>
                                    {% elif decision.status == 'rejected' %}
                                        <div class="avatar-sm rounded"><span class="h-6 mb-0 text-danger"><i class="ri-close-line"></i></span></div>
                                    {% else %}
                                        <div class="avatar-sm rounded"><span class="h-6 mb-0 text-warning"><i class="ri-edit-line"></i></span></div>
                                    {% endif %}
                                </div><div class="flex-grow-1 ms-3"><h6 class="mb-1">{{ decision.attendance.employee.first_name }} {{ decision.attendance.employee.last_name }}</h6><p class="mb-1 text-muted">{{ decision.attendance.attendance_date|date:"d M Y" }}</p><small class="text-muted"><i class="ri-time-line me-1"></i>
                                        {{ decision.reviewed_at|date:"H:i" }}
                                        {% if decision.tl_comments %}
                                            <br><i class="ri-message-3-line me-1"></i>{{ decision.tl_comments|truncatechars:50 }}
                                        {% endif %}
                                    </small></div></div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3"><i class="ri-history-line text-muted fs-2"></i><p class="text-muted mt-2">No recent decisions</p></div>
                    {% endif %}
                </div></div></div></div></div><!-- Approval Modals -->
{% for approval in pending_approvals %}
<!-- Approve Modal --><div class="modal fade" id="approveModal{{ approval.id }}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Approve Attendance</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="approve"><input type="hidden" name="approval_id" value="{{ approval.id }}"><div class="modal-body"><p>Are you sure you want to approve the attendance for <strong>{{ approval.attendance.employee.first_name }} {{ approval.attendance.employee.last_name }}</strong> on <strong>{{ approval.attendance.attendance_date|date:"d M Y" }}</strong>?</p>
                    
                    {% if approval.is_late_arrival %}
                        <div class="alert alert-warning"><i class="ri-alarm-warning-line me-2"></i>
                            This is a late arrival ({{ approval.late_minutes }} minutes). It will be marked as half-day leave.
                        </div>
                    {% endif %}
                    
                    <div class="mb-3"><label class="form-label">Comments (Optional)</label><textarea class="form-control" name="tl_comments" rows="3" placeholder="Add any comments..."></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-success"><i class="ri-check-line me-2"></i>Approve
                    </button></div></form></div></div></div><!-- Reject Modal --><div class="modal fade" id="rejectModal{{ approval.id }}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Reject Attendance</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject"><input type="hidden" name="approval_id" value="{{ approval.id }}"><div class="modal-body"><p>Are you sure you want to reject the attendance for <strong>{{ approval.attendance.employee.first_name }} {{ approval.attendance.employee.last_name }}</strong> on <strong>{{ approval.attendance.attendance_date|date:"d M Y" }}</strong>?</p><div class="alert alert-danger"><i class="ri-error-warning-line me-2"></i>
                        This will mark the employee as absent for the day.
                    </div><div class="mb-3"><label class="form-label">Reason for Rejection *</label><textarea class="form-control" name="tl_comments" rows="3" placeholder="Please provide a reason for rejection..." required></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-danger"><i class="ri-close-line me-2"></i>Reject
                    </button></div></form></div></div></div><!-- Modify Modal --><div class="modal fade" id="modifyModal{{ approval.id }}" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Modify Attendance</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form method="POST">
                {% csrf_token %}
                <input type="hidden" name="action" value="modify"><input type="hidden" name="approval_id" value="{{ approval.id }}"><div class="modal-body"><div class="row"><div class="col-md-6"><p><strong>Employee:</strong> {{ approval.attendance.employee.first_name }} {{ approval.attendance.employee.last_name }}</p><p><strong>Date:</strong> {{ approval.attendance.attendance_date|date:"d M Y" }}</p></div><div class="col-md-6"><p><strong>Current Check-in:</strong> 
                                {% if approval.attendance.check_in_time %}
                                    {{ approval.attendance.check_in_time|time:"H:i:s" }}
                                {% else %}
                                    Not recorded
                                {% endif %}
                            </p><p><strong>Current Check-out:</strong> 
                                {% if approval.attendance.check_out_time %}
                                    {{ approval.attendance.check_out_time|time:"H:i:s" }}
                                {% else %}
                                    Not recorded
                                {% endif %}
                            </p></div></div><hr><div class="row"><div class="col-md-6"><div class="mb-3"><label class="form-label">Modified Check-in Time</label><input type="time" class="form-control" name="modified_check_in_time" 
                                       value="{{ approval.attendance.check_in_time|time:'H:i' }}"><small class="text-muted">Leave blank to keep original</small></div></div><div class="col-md-6"><div class="mb-3"><label class="form-label">Modified Check-out Time</label><input type="time" class="form-control" name="modified_check_out_time"
                                       value="{{ approval.attendance.check_out_time|time:'H:i' }}"><small class="text-muted">Leave blank to keep original</small></div></div></div><div class="mb-3"><label class="form-label">Modification Comments</label><textarea class="form-control" name="tl_comments" rows="3" placeholder="Explain the modifications made..."></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-warning"><i class="ri-edit-line me-2"></i>Modify
                    </button></div></form></div></div></div>
{% endfor %}

{% endblock %}