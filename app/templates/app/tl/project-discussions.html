{% extends "app/base3.html" %} {% block content %}

<!-- CONTENT -->
<main class="content-wrap">
  <!-- Personalized Welcome Header -->
  <div class="row" style="margin-bottom: 18px">
    <div class="col-12">
      <div
        style="
          background: linear-gradient(135deg, #0b7368, #0a8a4a);
          color: white;
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #e5e7eb;
        "
      >
        <div class="row align-items-center">
          <div class="col-md-8">
            <h2 style="margin: 0; font-weight: 700">
              Project Discussions & Team Chat - {{
              request.session.tl_name|default:"Team Lead" }}
            </h2>
            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 16px">
              Communicate with your team and manage project discussions | {{
              "now"|date:"F d, Y" }}
            </p>
          </div>
          <div class="col-md-4 text-end">
            <small style="opacity: 0.8"
              ><i class="fa-solid fa-comments me-1"></i>
              Team Communication Center
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="d-flex justify-content-between mb-3"
    style="
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 10px 15px;
      border-radius: 4px;
    "
  >
    <div class="page-title">Project Discussions & Team Chat</div>
    <div class="d-flex gap-2">
      <button
        onclick="refreshChat()"
        style="
          background: #0a8a4a;
          color: white;
          border: none;
          padding: 6px 14px;
          border-radius: 6px;
          font-weight: 600;
        "
      >
        <i class="fa-solid fa-sync-alt me-1"></i>Refresh
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row" style="margin-bottom: 18px">
    <!-- Total Projects -->
    <div class="col-lg-4 col-md-6 col-12" style="margin-bottom: 15px">
      <div
        style="
          background: #fff;
          border-radius: 10px;
          border: 1px solid #edf0f1;
          padding: 20px;
          display: flex;
          align-items: center;
          gap: 18px;
          min-height: 120px;
        "
      >
        <div
          style="
            width: 70px;
            height: 70px;
            background: #f7faf9;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #0b7368;
          "
        >
          <i class="fa-solid fa-project-diagram"></i>
        </div>
        <div>
          <div style="font-size: 24px; font-weight: 700">
            {{ total_projects|default:0 }}
          </div>
          <div style="font-size: 14px; color: #6d7c83">Total Projects</div>
        </div>
      </div>
    </div>

    <!-- Team Members -->
    <div class="col-lg-4 col-md-6 col-12" style="margin-bottom: 15px">
      <div
        style="
          background: #fff;
          border-radius: 10px;
          border: 1px solid #edf0f1;
          padding: 20px;
          display: flex;
          align-items: center;
          gap: 18px;
          min-height: 120px;
        "
      >
        <div
          style="
            width: 70px;
            height: 70px;
            background: #f7faf9;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #1e90ff;
          "
        >
          <i class="fa-solid fa-users"></i>
        </div>
        <div>
          <div style="font-size: 24px; font-weight: 700">
            {{ team_size|default:0 }}
          </div>
          <div style="font-size: 14px; color: #6d7c83">Team Members</div>
        </div>
      </div>
    </div>

    <!-- Active Discussions -->
    <div class="col-lg-4 col-md-6 col-12" style="margin-bottom: 15px">
      <div
        style="
          background: #fff;
          border-radius: 10px;
          border: 1px solid #edf0f1;
          padding: 20px;
          display: flex;
          align-items: center;
          gap: 18px;
          min-height: 120px;
        "
      >
        <div
          style="
            width: 70px;
            height: 70px;
            background: #f7faf9;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #e63946;
          "
        >
          <i class="fa-solid fa-comments"></i>
        </div>
        <div>
          <div style="font-size: 24px; font-weight: 700">
            {{ recent_discussions.count|default:0 }}
          </div>
          <div style="font-size: 14px; color: #6d7c83">Recent Discussions</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row" style="margin-bottom: 20px">
    <!-- Projects and Team Sidebar -->
    <div class="col-lg-4 col-md-12">
      <!-- Projects Section -->
      <div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          overflow: hidden;
          height: auto;
          margin-bottom: 18px;
        "
      >
        <div
          style="
            background: #0b7368;
            color: #fff;
            padding: 14px 18px;
            font-size: 18px;
            font-weight: 700;
          "
        >
          <i class="fa-solid fa-project-diagram me-2"></i>My Projects
        </div>
        <div style="padding: 18px">
          {% if projects %}
          <div class="row g-3">
            {% for project in projects %}
            <div class="col-12">
              <div
                class="project-card {% if forloop.first %}active-project{% endif %}"
                data-project-id="{{ project.id }}"
                onclick="selectProject({{ project.id }})"
                style="
                  border: 1px solid #e8e8e8;
                  border-radius: 10px;
                  padding: 15px;
                  position: relative;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  margin-bottom: 12px;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
              >
                <div style="position: absolute; right: 15px; top: 15px">
                  {% if project.end_date >= timezone.now.date %}
                  <span class="badge bg-success">Active</span>
                  {% else %}
                  <span class="badge bg-secondary">Completed</span>
                  {% endif %}
                </div>
                <h6
                  style="
                    font-weight: 700;
                    margin-bottom: 8px;
                    padding-right: 80px;
                  "
                >
                  {{ project.project_name }}
                </h6>
                <p style="font-size: 14px; color: #6d7c83; margin-bottom: 8px">
                  {{ project.description|truncatewords:15 }}
                </p>
                <div
                  style="font-size: 12px; color: #9aa3a9; margin-bottom: 8px"
                >
                  <i class="fa-solid fa-users me-1"></i>
                  {{ project.team_members.count }} members
                </div>
                <div style="font-size: 12px; color: #9aa3a9">
                  <i class="fa-solid fa-calendar me-1"></i>
                  {{ project.start_date }} - {{ project.end_date }}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center" style="padding: 40px; color: #6d7c83">
            <i
              class="fa-solid fa-project-diagram"
              style="font-size: 48px; margin-bottom: 15px; color: #ccc"
            ></i>
            <h5>No Projects</h5>
            <p>No projects assigned to you yet.</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Team Members Section -->
      <div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          overflow: hidden;
          height: auto;
        "
      >
        <div
          style="
            background: #0b7368;
            color: #fff;
            padding: 14px 18px;
            font-size: 18px;
            font-weight: 700;
          "
        >
          <i class="fa-solid fa-users me-2"></i>Team Members
        </div>
        <div style="padding: 18px">
          {% if team_members %}
          <div class="row g-3">
            {% for member in team_members %}
            <div class="col-12">
              <div
                class="team-member-card"
                data-employee-id="{{ member.id }}"
                onclick="selectTeamMember({{ member.id }})"
                style="
                  border: 1px solid #e8e8e8;
                  border-radius: 10px;
                  padding: 15px;
                  position: relative;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  margin-bottom: 12px;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
              >
                <div style="display: flex; align-items: center; gap: 12px">
                  {% if member.image %}
                  <img
                    src="{{ member.image }}"
                    alt="{{ member.name }}"
                    class="rounded-circle"
                    style="width: 50px; height: 50px"
                  />
                  {% else %}
                  <div
                    class="bg-secondary rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 50px; height: 50px"
                  >
                    <i class="fas fa-user text-white"></i>
                  </div>
                  {% endif %}
                  <div style="flex: 1">
                    <h6 style="font-weight: 700; margin: 0 0 4px 0">
                      {{ member.name }}
                    </h6>
                    <small style="color: #6d7c83"
                      >{{ member.designation }}</small
                    >
                    <br />
                    <small style="color: #1e90ff">{{ member.role }}</small>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center" style="padding: 40px; color: #6d7c83">
            <i
              class="fa-solid fa-users"
              style="font-size: 48px; margin-bottom: 15px; color: #ccc"
            ></i>
            <h5>No Team Members</h5>
            <p>No team members assigned.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="col-lg-8 col-md-12">
      <div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          overflow: hidden;
          height: auto;
        "
      >
        <div
          style="
            background: #0b7368;
            color: #fff;
            padding: 14px 18px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <i class="fa-solid fa-comments me-2"></i>
            <span id="chat-title">Project Discussions</span>
          </div>
          <div>
            <span
              id="unread-count"
              class="badge bg-danger"
              style="display: none"
              >0</span
            >
          </div>
        </div>
        <div style="padding: 18px">
          <!-- Chat Container -->
          <div
            class="chat-container"
            id="chat-container"
            style="
              height: 600px;
              overflow-y: auto;
              border: 1px solid #dee2e6;
              border-radius: 0.375rem;
              padding: 1rem;
              background-color: #f8f9fa;
              margin-bottom: 1rem;
            "
          >
            {% if recent_discussions %}
            {% for discussion in recent_discussions %}
            <div
              class="message {% if discussion.sender_tl == tl %}sent{% else %}received{% endif %}"
              style="
                margin-bottom: 1rem;
                padding: 0.75rem;
                border-radius: 0.5rem;
                max-width: 80%;
                {% if discussion.sender_tl == tl %}
                margin-left: auto;
                text-align: right;
                background-color: #d1ecf1;
                border: 1px solid #bee5eb;
                {% else %}
                margin-right: auto;
                background-color: #f8d7da;
                border: 1px solid #f5c6cb;
                {% endif %}
                clear: both;
              "
            >
              <div
                class="message-header"
                style="
                  font-size: 0.875rem;
                  color: #6c757d;
                  margin-bottom: 0.25rem;
                "
              >
                <strong>{{ discussion.get_sender_name }}</strong>
                <span
                  class="badge bg-{% if discussion.priority == 'urgent' %}danger{% elif discussion.priority == 'high' %}warning{% else %}info{% endif %} ms-1"
                >
                  {{ discussion.get_priority_display }}
                </span>
                <small class="text-muted"
                  >{{ discussion.created_at|timesince }} ago</small
                >
              </div>
              <div class="message-content" style="word-wrap: break-word">
                {% if discussion.subject %}
                <strong>{{ discussion.subject }}</strong><br />
                {% endif %} {{ discussion.content|linebreaksbr }}
              </div>
              {% if discussion.attachment %}
              <div class="mt-2">
                <a
                  href="{{ discussion.attachment.url }}"
                  class="btn btn-sm btn-outline-primary"
                  target="_blank"
                >
                  <i class="fas fa-paperclip me-1"></i>
                  {{ discussion.attachment_name|default:"Attachment" }}
                </a>
              </div>
              {% endif %}
            </div>
            {% endfor %} {% else %}
            <div class="text-center text-muted">
              <i class="fas fa-comments fa-3x mb-3"></i>
              <p>No discussions yet. Start a conversation!</p>
            </div>
            {% endif %}
          </div>

          <!-- Message Input -->
          <div class="chat-input">
            <form id="message-form">
              <div class="row g-2 mb-2">
                <div class="col-md-6">
                  <input
                    type="text"
                    id="subject-input"
                    class="form-control"
                    placeholder="Subject (optional)"
                    maxlength="255"
                  />
                </div>
                <div class="col-md-3">
                  <select id="priority-select" class="form-select">
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <select id="message-type-select" class="form-select">
                    <option value="message">Message</option>
                    <option value="update">Update</option>
                    <option value="task_assignment">Task</option>
                    <option value="status_report">Report</option>
                  </select>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-md-8">
                  <textarea
                    id="message-input"
                    class="form-control"
                    placeholder="Type your message..."
                    maxlength="2000"
                    rows="3"
                  ></textarea>
                </div>
                <div class="col-md-2">
                  <input
                    type="file"
                    id="attachment-input"
                    class="form-control"
                    accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"
                  />
                </div>
                <div class="col-md-2">
                  <button
                    type="submit"
                    class="btn btn-primary w-100"
                    style="background: #0b7368; border-color: #0b7368"
                  >
                    <i class="fas fa-paper-plane"></i> Send
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  let currentProjectId = null;
  let currentChatMode = "project"; // 'project' or 'direct'
  let currentEmployeeId = null;

  // Auto-select first project
  document.addEventListener("DOMContentLoaded", function () {
    const firstProject = document.querySelector(".project-card");
    if (firstProject) {
      selectProject(firstProject.dataset.projectId);
    }

    // Load recent conversations
    loadRecentConversations();
  });

  // Project selection function
  function selectProject(projectId) {
    currentProjectId = projectId;
    currentChatMode = "project";
    currentEmployeeId = null;

    // Update UI
    document.querySelectorAll(".project-card").forEach((card) => {
      card.classList.remove("active-project");
      card.style.borderLeft = "none";
      card.style.backgroundColor = "#fff";
    });

    const selectedCard = document.querySelector(
      `[data-project-id="${projectId}"]`
    );
    if (selectedCard) {
      selectedCard.classList.add("active-project");
      selectedCard.style.borderLeft = "4px solid #0d6efd";
      selectedCard.style.backgroundColor = "#f8f9ff";
      const projectName = selectedCard.querySelector("h6").textContent;
      document.getElementById(
        "chat-title"
      ).textContent = `Project: ${projectName}`;
    }

    // Load project discussions
    loadProjectDiscussions(projectId);
  }

  // Team member selection function
  function selectTeamMember(employeeId) {
    currentEmployeeId = employeeId;
    currentChatMode = "direct";
    currentProjectId = null;

    // Update UI
    document.querySelectorAll(".team-member-card").forEach((card) => {
      card.classList.remove("active-team-member");
      card.style.borderLeft = "none";
      card.style.backgroundColor = "#fff";
    });

    const selectedCard = document.querySelector(
      `[data-employee-id="${employeeId}"]`
    );
    if (selectedCard) {
      selectedCard.classList.add("active-team-member");
      selectedCard.style.borderLeft = "4px solid #0d6efd";
      selectedCard.style.backgroundColor = "#f8f9ff";
      const memberName = selectedCard.querySelector("h6").textContent;
      document.getElementById(
        "chat-title"
      ).textContent = `Direct Chat: ${memberName}`;
    }

    // Load direct conversations
    loadDirectConversations(employeeId);
  }

  // Load project discussions
  function loadProjectDiscussions(projectId) {
    const container = document.getElementById("chat-container");
    container.innerHTML =
      '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading discussions...</div>';

    fetch(`/get-project-discussions/?project_id=${projectId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          displayDiscussions(data.discussions);
        } else {
          container.innerHTML =
            '<div class="text-center text-muted">Error loading discussions</div>';
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        container.innerHTML =
          '<div class="text-center text-muted">Error loading discussions</div>';
      });
  }

  // Load direct conversations
  function loadDirectConversations(employeeId) {
    const container = document.getElementById("chat-container");
    container.innerHTML =
      '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading conversations...</div>';

    fetch(`/get-conversations/?employee_id=${employeeId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          displayConversations(data.conversations);
        } else {
          container.innerHTML =
            '<div class="text-center text-muted">No conversations found</div>';
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        container.innerHTML =
          '<div class="text-center text-muted">Error loading conversations</div>';
      });
  }

  // Load recent conversations
  function loadRecentConversations() {
    fetch("/get-conversations/")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Store recent conversations for display
          window.recentConversations = data.conversations;
        }
      })
      .catch((error) => {
        console.error("Error loading recent conversations:", error);
      });
  }

  // Display project discussions
  function displayDiscussions(discussions) {
    const container = document.getElementById("chat-container");

    if (discussions.length === 0) {
      container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>No discussions yet. Start a conversation!</p>
            </div>
        `;
      return;
    }

    let html = "";
    discussions.forEach((discussion) => {
      // Check if the current user is the sender (more robust logic)
      const isCurrentUser =
        (discussion.sender_type === "tl" && discussion.sender_tl_id) ||
        (discussion.sender_employee_id &&
          discussion.sender_type === "employee");
      const isSent = isCurrentUser && discussion.sender_type === "tl";

      html += `
            <div class="message ${isSent ? "sent" : "received"}" style="
                margin-bottom: 1rem;
                padding: 0.75rem;
                border-radius: 0.5rem;
                max-width: 80%;
                clear: both;
                ${
                  isSent
                    ? "background-color: #d1ecf1; margin-left: auto; text-align: right; border: 1px solid #bee5eb;"
                    : "background-color: #f8d7da; margin-right: auto; border: 1px solid #f5c6cb;"
                }
            ">
                <div class="message-header" style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.25rem;">
                    <strong>${discussion.sender_name}</strong>
                    <span class="badge bg-${
                      discussion.priority === "urgent"
                        ? "danger"
                        : discussion.priority === "high"
                        ? "warning"
                        : "info"
                    } ms-1">
                        ${discussion.priority_display}
                    </span>
                    <small class="text-muted">${
                      discussion.created_at_human
                    }</small>
                </div>
                <div class="message-content" style="word-wrap: break-word;">
                    ${
                      discussion.subject
                        ? `<strong>${discussion.subject}</strong><br>`
                        : ""
                    }
                    ${discussion.content.replace(/\n/g, "<br>")}
                </div>
                ${
                  discussion.attachment
                    ? `
                    <div class="mt-2">
                        <a href="${discussion.attachment_url}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-paperclip me-1"></i>
                            ${discussion.attachment_name}
                        </a>
                    </div>
                `
                    : ""
                }
            </div>
        `;
    });

    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
  }

  // Display direct conversations
  function displayConversations(conversations) {
    const container = document.getElementById("chat-container");

    if (conversations.length === 0) {
      container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-comment fa-3x mb-3"></i>
                <p>No conversations yet. Start a chat!</p>
            </div>
        `;
      return;
    }

    let html = "";
    conversations.forEach((chat) => {
      // Check if the current user is the sender (more robust logic)
      const isCurrentUser =
        (chat.sender_type === "tl" && chat.sender_tl_id) ||
        (chat.sender_employee_id && chat.sender_type === "employee");
      const isSent = isCurrentUser && chat.sender_type === "tl";

      html += `
            <div class="message ${isSent ? "sent" : "received"}" style="
                margin-bottom: 1rem;
                padding: 0.75rem;
                border-radius: 0.5rem;
                max-width: 80%;
                clear: both;
                ${
                  isSent
                    ? "background-color: #d1ecf1; margin-left: auto; text-align: right; border: 1px solid #bee5eb;"
                    : "background-color: #f8d7da; margin-right: auto; border: 1px solid #f5c6cb;"
                }
            ">
                <div class="message-header" style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.25rem;">
                    <strong>${chat.sender_name}</strong>
                    <small class="text-muted">${chat.created_at_human}</small>
                </div>
                <div class="message-content" style="word-wrap: break-word;">
                    ${
                      chat.subject ? `<strong>${chat.subject}</strong><br>` : ""
                    }
                    ${chat.message.replace(/\n/g, "<br>")}
                </div>
                ${
                  chat.attachment
                    ? `
                    <div class="mt-2">
                        <a href="${chat.attachment_url}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="fas fa-paperclip me-1"></i>
                            ${chat.attachment_name}
                        </a>
                    </div>
                `
                    : ""
                }
            </div>
        `;
    });

    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
  }

  // Message form submission
  document
    .getElementById("message-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const subjectInput = document.getElementById("subject-input");
      const prioritySelect = document.getElementById("priority-select");
      const messageTypeSelect = document.getElementById("message-type-select");
      const messageInput = document.getElementById("message-input");
      const attachmentInput = document.getElementById("attachment-input");

      const subject = subjectInput.value.trim();
      const priority = prioritySelect.value;
      const messageType = messageTypeSelect.value;
      const message = messageInput.value.trim();
      const attachment = attachmentInput.files[0];

      if (!message) {
        alert("Please enter a message");
        return;
      }

      if (currentChatMode === "project" && !currentProjectId) {
        alert("Please select a project first");
        return;
      }

      if (currentChatMode === "direct" && !currentEmployeeId) {
        alert("Please select a team member first");
        return;
      }

      sendMessage(message, subject, priority, messageType, attachment);

      // Clear form
      subjectInput.value = "";
      messageInput.value = "";
      attachmentInput.value = "";
    });

  // Send message function
  function sendMessage(message, subject, priority, messageType, attachment) {
    const formData = new FormData();

    if (currentChatMode === "project") {
      formData.append("project_id", currentProjectId);
      formData.append("receiver_type", "team"); // Broadcast to team
    } else if (currentChatMode === "direct") {
      formData.append("receiver_type", "employee");
      formData.append("receiver_id", currentEmployeeId);
      formData.append("chat_type", "direct");
    }

    formData.append("message", message);
    formData.append("subject", subject);
    formData.append("priority", priority);
    formData.append("message_type", messageType);

    if (attachment) {
      formData.append("attachment", attachment);
    }

    const url =
      currentChatMode === "project"
        ? "/send-project-message/"
        : "/send-team-message/";

    fetch(url, {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Refresh the chat
          if (currentChatMode === "project") {
            loadProjectDiscussions(currentProjectId);
          } else {
            loadDirectConversations(currentEmployeeId);
          }
          showAlert("Message sent successfully!", "success");
        } else {
          showAlert("Error: " + data.error, "danger");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showAlert("Error sending message", "danger");
      });
  }

  // Refresh chat function
  function refreshChat() {
    if (currentChatMode === "project" && currentProjectId) {
      loadProjectDiscussions(currentProjectId);
    } else if (currentChatMode === "direct" && currentEmployeeId) {
      loadDirectConversations(currentEmployeeId);
    }
  }

  // Auto-refresh every 30 seconds
  setInterval(function () {
    if (currentChatMode === "project" && currentProjectId) {
      loadProjectDiscussions(currentProjectId);
    } else if (currentChatMode === "direct" && currentEmployeeId) {
      loadDirectConversations(currentEmployeeId);
    }
  }, 30000);

  // Utility function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Show alert function
  function showAlert(message, type) {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
      alertDiv.remove();
    }, 5000);
  }
</script>

{% endblock %}
