{% extends "app/base.html" %} {% block content %}
<!-- CONTENT --><main class="content-wrap">
  {% if messages %}
  <div id="msgBox">
    {% for msg in messages %}
    <div
      style="
        background: #0b7368;
        color: white;
        padding: 12px;
        border-radius: 6px;
        font-weight: 600;
        text-align: center;
        margin-bottom: 15px;
      ">
      {{ msg }}
    </div>
    {% endfor %}
  </div><script>
    setTimeout(function () {
      var box = document.getElementById("msgBox");
      if (box) {
        box.style.display = "none";
      }
    }, 7000);
  </script>
  {% endif %}

  <div
    class="d-flex justify-content-between mb-3"
    style="
      background: #fff;
      border: 1px solid #e5e7eb;
      padding: 10px 15px;
      border-radius: 4px;
    "><div class="page-title">
      Employee Management
    </div><a href="/hr/dashboard.html"><div class="text-muted">
        Dashboard
      </div></a></div><div class="row g-3" style="margin-top: 20px"><!-- CARD 1 --><div class="col-lg-3 col-md-6"><div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          padding: 25px;
          text-align: center;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
          position: relative;
        "><!-- top teal bar --><div
          style="
            height: 6px;
            background: #0b7368;
            border-radius: 12px 12px 0 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
          "></div><i
          class="fa-solid fa-users"
          style="font-size: 32px; color: #007bff; margin-top: 5px"></i><div style="font-size: 28px; font-weight: 700; margin-top: 10px">
          {{ total_employees }}

        </div><div
          style="color: #6c757d; font-size: 16px">
          Total Employees
        </div></div></div><!-- CARD 2 --><div class="col-lg-3 col-md-6"><div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          padding: 25px;
          text-align: center;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
          position: relative;
        "><div
          style="
            height: 6px;
            background: #0b7368;
            border-radius: 12px 12px 0 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
          "></div><i
          class="fa-solid fa-user-check"
          style="font-size: 32px; color: #1b8c3b; margin-top: 5px"></i><div style="font-size: 28px; font-weight: 700; margin-top: 10px">
          {{ active_employees }}

        </div><div style="color: #6c757d; font-size: 16px">Active Employees</div></div></div><!-- CARD 3 --><div class="col-lg-3 col-md-6"><div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          padding: 25px;
          text-align: center;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
          position: relative;
        "><div
          style="
            height: 6px;
            background: #0b7368;
            border-radius: 12px 12px 0 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
          "></div><i
          class="fa-solid fa-user-clock"
          style="font-size: 32px; color: #f1c40f; margin-top: 5px"></i><div style="font-size: 28px; font-weight: 700; margin-top: 10px">
          {{ new_this_month }}

        </div><div style="color: #6c757d; font-size: 16px">New This Month</div></div></div><!-- CARD 4 --><div class="col-lg-3 col-md-6"><div
        style="
          background: #fff;
          border-radius: 12px;
          border: 1px solid #e5e7eb;
          padding: 25px;
          text-align: center;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
          position: relative;
        "><div
          style="
            height: 6px;
            background: #0b7368;
            border-radius: 12px 12px 0 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
          "></div><i
          class="fa-solid fa-user-xmark"
          style="font-size: 32px; color: #e63946; margin-top: 5px"></i><div style="font-size: 28px; font-weight: 700; margin-top: 10px">
          {{ resigned_this_month }}

        </div><div style="color: #6c757d; font-size: 16px">Resigned This Month</div></div></div></div><!-- ============================
     ACTION HEADER SECTION
     ============================ --><div
    style="
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    "><div class="row align-items-center"><!-- LEFT BUTTONS --><div class="col-md-6" style="display: flex; gap: 12px"><!-- OPEN FORM BUTTON --><button
          onclick="document.getElementById('empFormBox').style.display='block';"
          style="
            background: #0b7368;
            color: #fff;
            font-weight: 700;
            padding: 10px 22px;
            border-radius: 8px;
            border: none;
          "><i class="fa-solid fa-user-plus me-2"></i>Add Employee
        </button><!-- EXPORT BUTTON --><a href="{% url 'export-employees' %}"><button
  style="
    background: #34a853;
    color: #fff;
    font-weight: 700;
    padding: 10px 22px;
    border-radius: 8px;
    border: none;
  "><i class="fa-solid fa-download me-2"></i>Export
</button></a></div><!-- RIGHT INPUTS --><div
        class="col-md-6"
        style="display: flex; justify-content: end; gap: 12px"><input
  type="text"
  id="searchEmployee"
  class="form-control"
  placeholder="Search employees..."
  style="width: 220px; border-radius: 8px; border: 1px solid #d1d5db"
/><select id="departmentFilter"
        class="form-select"
        style="width: 180px; border-radius: 8px; border: 1px solid #d1d5db"><option value="All">All Departments</option><option>IT</option><option>HR</option><option>Finance</option><option>Admin</option><option>Operations</option></select></div></div></div><!-- ============================
     EMPLOYEE TABLE SECTION
     ============================ --><div
    style="
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    "><!-- TABLE HEADER --><div
      style="
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        background-color: #007070;
      "><h5 style="margin: 0; font-weight: 700; color: #eeebeb">
        Employee Directory
      </h5></div><!-- EMPLOYEE TABLE (DESKTOP VIEW) --><div class="desktop-table" style="overflow-x: auto"><table class="table table-hover mb-0" style="width: 100%"><thead style="background: #f8f9fa"><tr><th
              style="
                padding: 15px;
                border-bottom: 2px solid #dee2e6;
                cursor: pointer;
                font-weight: 600;
              "
              onclick="sortTable(0)">
              Employee <i class="fas fa-sort ms-1"></i></th><th
              style="
                padding: 15px;
                border-bottom: 2px solid #dee2e6;
                cursor: pointer;
                font-weight: 600;
              "
              onclick="sortTable(1)">
              Department <i class="fas fa-sort ms-1"></i></th><th
              style="
                padding: 15px;
                border-bottom: 2px solid #dee2e6;
                cursor: pointer;
                font-weight: 600;
              "
              onclick="sortTable(2)">
              Job Title <i class="fas fa-sort ms-1"></i></th><th
              style="
                padding: 15px;
                border-bottom: 2px solid #dee2e6;
                cursor: pointer;
                font-weight: 600;
              "
              onclick="sortTable(3)">
              Status <i class="fas fa-sort ms-1"></i></th><th
              style="
                padding: 15px;
                border-bottom: 2px solid #dee2e6;
                cursor: pointer;
                font-weight: 600;
              "
              onclick="sortTable(4)">
              Date Joined <i class="fas fa-sort ms-1"></i></th><th
              style="
                padding: 15px;
                border-bottom: 2px solid #dee2e6;
                font-weight: 600;
              ">
              Actions
            </th></tr></thead><tbody id="employeeTableBody">

    {% for emp in employees %}
    <tr id="employee-row-{{ emp.id }}"><td style="padding: 15px"><div class="d-flex align-items-center"><div class="avatar me-3"
                    style="width:40px;height:40px;border-radius:50%;background:#0b7368;color:#fff;
                           display:flex;align-items:center;justify-content:center;font-weight:700;">
                    {{ emp.first_name|first }}{{ emp.last_name|first }}
                </div><div><div style="font-weight:600;">
                        {{ emp.first_name }} {{ emp.last_name }}
                    </div><div style="color:#6c757d;font-size:12px;">
                        {{ emp.company_id }}
                    </div><div style="color:#6c757d;font-size:12px;">
                        {{ emp.email }}
                    </div></div></div></td><td style="padding:15px;">{{ emp.department }}</td><td style="padding:15px;">{{ emp.designation }}</td><td style="padding:15px;">
            {% if emp.resigned_date %}
                <span class="badge bg-danger">Resigned</span>
            {% else %}
                <span class="badge bg-success">Active</span>
            {% endif %}
        </td><td style="padding:15px;">
            {{ emp.created_at|date:"M d, Y" }}
        </td><td style="padding:15px;"><div class="btn-group" role="group"><button class="btn btn-sm btn-outline-primary"
             onclick="openEmployeeModal('{{ emp.id }}')"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-secondary"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee('{{ emp.id }}')"><i class="fas fa-trash"></i></button></div></td></tr>
    {% endfor %}

    {% if employees|length == 0 %}
    <tr><td colspan="6" class="text-center py-4">
            No Employees Found
        </td></tr>
    {% endif %}

</tbody></table></div><!-- EMPLOYEE CARDS (MOBILE VIEW) --><div class="mobile-cards d-md-none" id="employeeCards"><!-- Employee cards will be populated by JavaScript --></div><!-- TABLE FOOTER WITH PAGINATION --><div
      style="
        padding: 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      "><div style="font-size: 14px; color: #6c757d">
        Showing <span id="showingFrom">1</span> to
        <span id="showingTo">10</span> of
        <span id="totalEmployees">15</span> employees
      </div><nav><ul class="pagination pagination-sm mb-0" id="pagination"><!-- Pagination will be populated by JavaScript --></ul></nav></div></div><!-- ============================
     POPUP FORM (EMPLOYEE ADD)
============================= --><div
    id="empFormBox"
    style="
      display: none;
      position: fixed;
      left: 50%;
      top: 20%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 800px;
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-height: 70vh;
      overflow-y: auto;
    "><!-- HEADER --><div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #e6e6e6;
        padding-bottom: 10px;
      "><h4 style="margin: 0; color: #0b7368; font-weight: 700">
        Add New Employee
      </h4><button
        onclick="document.getElementById('empFormBox').style.display='none';"
        style="
          border: none;
          background: none;
          font-size: 22px;
          font-weight: 700;
          color: #333;
        ">
        &times;
      </button></div><!-- FORM --><form method="POST" enctype="multipart/form-data" id="employeeForm" action="{% url 'employee-management' %}">

  {% csrf_token %}

  <!-- ROW 1 --><div class="row mb-3"><div class="col-md-4"><label class="form-label" style="color:#0b7368">First Name</label><input type="text" class="form-control" name="first_name"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Last Name</label><input type="text" class="form-control" name="last_name"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Email</label><input type="email" class="form-control" name="email"></div></div><!-- ROW 2 --><div class="row mb-3"><div class="col-md-4"><label class="form-label" style="color:#0b7368">Password</label><input type="password" class="form-control" name="password"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Company ID</label><input type="text" class="form-control" name="company_id"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Official Email</label><input type="email" class="form-control" name="official_email"></div></div><!-- ROW 3 --><div class="row mb-3"><div class="col-md-4"><label class="form-label" style="color:#0b7368">Official Password</label><input type="password" class="form-control" name="official_password"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Designation</label><input type="text" class="form-control" name="designation"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Department</label><input type="text" class="form-control" name="department"></div></div><!-- ROW 4 - FAMILY --><div class="row mb-3"><div class="col-md-6"><label class="form-label" style="color:#0b7368">Contact Number</label><input type="text" class="form-control" name="contact_number"></div><div class="col-md-6"><label class="form-label" style="color:#0b7368">Family Contact Number</label><input type="text" class="form-control" name="family_contact_number"></div></div><!-- ROW 5 FAMILY --><div class="row mb-3"><div class="col-md-6"><label class="form-label" style="color:#0b7368">Family Relation</label><select class="form-select" name="family_relation"><option value="">Select Relation</option><option value="Father">Father</option><option value="Mother">Mother</option><option value="Brother">Brother</option><option value="Sister">Sister</option><option value="Grand Father">Grand Father</option></select></div><div class="col-md-6"><label class="form-label" style="color:#0b7368">Certifications</label><input type="text" class="form-control" name="certifications"></div></div><!-- ROW 6 --><div class="row mb-3"><div class="col-md-6"><label class="form-label" style="color:#0b7368">Employee Image</label><input type="file" class="form-control" name="image"></div></div><!-- ROW 9 --><div class="row mb-3"><div class="col-md-4"><label class="form-label" style="color:#0b7368">Package (CTC)</label><input type="number" class="form-control" name="package" step="0.01"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Contract Years</label><input type="number" class="form-control" name="contract_years"></div><div class="col-md-4"><label class="form-label" style="color:#0b7368">Contract Start</label><input type="date" class="form-control" name="contract_start_date"></div></div><!-- ROW 10 --><div class="row mb-3"><div class="col-md-4"><label class="form-label" style="color:#0b7368">Contract End</label><input type="date" class="form-control" name="contract_end_date"></div><div class="col-md-8"><label class="form-label" style="color:#0b7368">Address</label><textarea class="form-control" name="address"></textarea></div></div><!-- SUBMIT --><div style="text-align:right;"><button class="btn btn-secondary"
      onclick="document.getElementById('empFormBox').style.display='none'; return false;">
      Cancel
    </button><button class="btn" style="background:#0b7368; color:#fff; font-weight:700;">
      Save Employee
    </button></div></form></div></div></main><!-- BACKDROP --><div id="empBackdrop"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9998;"></div><!-- EMPLOYEE MODAL --><div id="employeeModal"
     style="display:none; position:fixed; inset:0; z-index:9999;
            padding:40px 10px; overflow-y:auto;"><div style="max-width:900px; margin:auto; background:#fff;
                border-radius:12px; padding:25px;
                border-top:6px solid #0b7368; position:relative;"><!-- Close --><button onclick="closeEmployeeModal()" 
                style="position:absolute; right:15px; top:10px; 
                       font-size:28px; background:none; border:none;">×</button><h3 style="color:#0b7368; font-weight:700; margin-bottom:20px;">
            Employee Details
        </h3><div style="display:flex; gap:25px; flex-wrap:wrap;"><!-- IMAGE --><div style="flex:0 0 180px;"><img id="empImage"
                     style="width:180px; height:180px; border-radius:12px;
                            object-fit:cover; border:3px solid #0b7368;"></div><!-- DETAILS --><div style="flex:1;"><div class="detail-grid"><div><b>Name:</b><br><span id="empName"></span></div><div><b>Email:</b><br><span id="empEmail"></span></div><div><b>Company ID:</b><br><span id="empCID"></span></div><div><b>Department:</b><br><span id="empDept"></span></div><div><b>Designation:</b><br><span id="empDesignation"></span></div><div><b>Phone:</b><br><span id="empPhone"></span></div><div><b>Family Contact:</b><br><span id="empFamNo"></span></div><div><b>Family Relation:</b><br><span id="empFamilyRelation"></span></div><div><b>Certifications:</b><br><span id="empCertifications"></span></div><div><b>Package:</b><br><span id="empPackage"></span></div><div style="grid-column:1 / span 3;"><b>Address:</b><br><span id="empAddress"></span></div></div></div></div></div></div><style>
.detail-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}
@media (max-width:768px) {
    .detail-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width:500px) {
    .detail-grid {
        grid-template-columns: 1fr;
    }
}

/* Animations for delete success message */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Table row hover effects */
#employeeTableBody tr {
    transition: all 0.2s ease;
}

#employeeTableBody tr:hover {
    background-color: #f8f9fa;
}
</style><script>

function openEmployeeModal(empID) {

    fetch(`/get-employee/${empID}/`)
    .then(res => res.json())
    .then(data => {

        let emp = data.emp;

        // BASIC DETAILS
        document.getElementById("empName").innerText = emp.first_name + " " + emp.last_name;
        document.getElementById("empEmail").innerText = emp.email;
        document.getElementById("empCID").innerText = emp.company_id;

        document.getElementById("empDept").innerText = emp.department;
        document.getElementById("empDesignation").innerText = emp.designation;
        document.getElementById("empPhone").innerText = emp.contact_number;

        // FAMILY
        document.getElementById("empFamNo").innerText = emp.family_contact_number;
        document.getElementById("empFamilyRelation").innerText = emp.family_relation || 'N/A';

        // CERTIFICATIONS
        document.getElementById("empCertifications").innerText = emp.certifications || 'N/A';

        document.getElementById("empPackage").innerText = emp.package;
        document.getElementById("empAddress").innerText = emp.address;

        // IMAGE FIX — ALWAYS WORKS
        let img = emp.image;

        if (img && img !== "") {
            if (!img.startsWith("/media/")) {
                img = "/media/" + img;
            }
            document.getElementById("empImage").src = img;
        } else {
            document.getElementById("empImage").src = "/static/default.png";
        }

        document.getElementById("employeeModal").style.display = "block";
        document.getElementById("empBackdrop").style.display = "block";
    });
}

function closeEmployeeModal(){
    document.getElementById("employeeModal").style.display = "none";
    document.getElementById("empBackdrop").style.display = "none";
}
</script><script>
document.addEventListener("DOMContentLoaded", function () {

    const searchInput = document.getElementById("searchEmployee");
    const tableRows = document.querySelectorAll("#employeeTableBody tr");

    searchInput.addEventListener("keyup", function () {

        let value = this.value.toLowerCase().trim();

        tableRows.forEach(row => {
            let text = row.innerText.toLowerCase();

            if (text.includes(value)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });

});
</script><script>
function deleteEmployee(empID) {

    if (!confirm("Are you sure you want to delete this employee?")) {
        return;
    }

    // Show loading state on the delete button
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`/delete-employee/${empID}/`, {
        method: "DELETE",
        headers: {
            "X-CSRFToken": getCSRF(),
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Smoothly remove the table row with animation
            const row = document.getElementById(`employee-row-${empID}`);
            if (row) {
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    row.remove();
                    
                    // Update employee count if needed
                    updateEmployeeCount();
                    
                    // Show success message
                    showSuccessMessage("Employee deleted successfully!");
                }, 300);
            }
        } else {
            alert("Error: " + data.message);
            // Restore button state
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("An error occurred while deleting the employee.");
        // Restore button state
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// Function to update employee count (you can enhance this based on your needs)
function updateEmployeeCount() {
    const remainingRows = document.querySelectorAll('#employeeTableBody tr').length;
    const totalElement = document.getElementById('totalEmployees');
    if (totalElement) {
        totalElement.textContent = remainingRows;
    }
}

// Function to show success message
function showSuccessMessage(message) {
    // Create a temporary success message
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #0b7368;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        font-weight: 600;
        animation: slideIn 0.3s ease;
    `;
    successDiv.textContent = message;
    
    document.body.appendChild(successDiv);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        successDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 300);
    }, 3000);
}

// CSRF token extractor
function getCSRF() {
    let cookieValue = null;
    const cookies = document.cookie.split(';');
    for (let i of cookies) {
        const c = i.trim();
        if (c.startsWith("csrftoken=")) {
            cookieValue = c.substring("csrftoken=".length);
            break;
        }
    }
    return cookieValue;
}
</script><script>

  document.getElementById("departmentFilter").addEventListener("change", function () {
    let selectedDept = this.value.toLowerCase();
    let rows = document.querySelectorAll("#employeeTableBody tr");

    rows.forEach(row => {
        let dept = row.querySelector("td:nth-child(2)").innerText.toLowerCase();

        if (selectedDept === "all" || dept === selectedDept) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});

</script>
{% endblock %}
