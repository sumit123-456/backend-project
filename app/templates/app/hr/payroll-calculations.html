{% extends 'app/base.html' %}

{% block title %}HR - Payroll Calculations{% endblock %}

{% block content %}
<main class="content-wrap"><!-- Page Title --><div class="d-flex justify-content-between mb-3" style="background:#fff;border:1px solid #e5e7eb;padding:10px 15px;border-radius:4px;"><h4 class="mb-sm-0">Payroll Calculations & Processing</h4><a href="{% url 'hr-dashboard' %}"><div class="text-muted">Dashboard</div></a></div><!-- Statistics Cards --><div style="display:flex; gap:20px; flex-wrap:wrap; margin:20px 0; font-family:Poppins, sans-serif;"><!-- CARD 1 - Total Payrolls --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                    border-top:6px solid #0b7368; padding:25px; text-align:center;
                    box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#0a6d65; margin-bottom:8px;"><i class="ri-money-dollar-circle-line"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ total_payrolls }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Total Payrolls</div></div><!-- CARD 2 - Processed --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                    border-top:6px solid #0b7368; padding:25px; text-align:center;
                    box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#28a745; margin-bottom:8px;"><i class="ri-check-double-line"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ processed_payrolls }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Processed</div></div><!-- CARD 3 - Pending --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                    border-top:6px solid #0b7368; padding:25px; text-align:center;
                    box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#ffc107; margin-bottom:8px;"><i class="ri-time-line"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ pending_payrolls }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Pending</div></div><!-- CARD 4 - Employees --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                    border-top:6px solid #0b7368; padding:25px; text-align:center;
                    box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#17a2b8; margin-bottom:8px;"><i class="ri-user-line"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ employees|length }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Employees</div></div></div><!-- Main Content Area --><div class="row"><!-- Calculate Payroll Form --><div class="col-lg-4"><div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin:20px 0;"><div style="background:#0b7368;color:#fff;padding:15px;border-radius:10px 10px 0 0;"><h5 style="margin:0; font-weight:600;"><i class="ri-calculator-line me-2"></i>
                        Calculate Payroll
                    </h5></div><div style="padding:20px;">
                    {% if messages %}
                        {% for message in messages %}
                            <div style="background:#d1edff;border:1px solid #b3d9ff;color:#004085;padding:12px;border-radius:6px;margin-bottom:15px;">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="calculate_payroll"><div style="margin-bottom:15px;"><label style="font-weight:600; color:#333; font-size:14px;">Select Employee</label><select style="padding:10px 15px; width:100%; border:1px solid #ddd;
                                           border-radius:6px; outline:none; font-size:14px;" name="employee" required><option value="">Choose Employee</option>
                                {% for employee in employees %}
                                <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }} ({{ employee.company_id }})</option>
                                {% endfor %}
                            </select></div><div style="margin-bottom:15px;"><label style="font-weight:600; color:#333; font-size:14px;">Select Month</label><select style="padding:10px 15px; width:100%; border:1px solid #ddd;
                                           border-radius:6px; outline:none; font-size:14px;" name="month" required><option value="">Choose Month</option>
                                {% for month in months %}
                                <option value="{{ month }}">{{ month }}</option>
                                {% endfor %}
                            </select></div><div style="margin-bottom:15px;"><label style="font-weight:600; color:#333; font-size:14px;">Select Year</label><select style="padding:10px 15px; width:100%; border:1px solid #ddd;
                                           border-radius:6px; outline:none; font-size:14px;" name="year" required><option value="">Choose Year</option>
                                {% for year in years %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select></div><div style="margin-bottom:15px;"><label style="font-weight:600; color:#333; font-size:14px;">Allowances (₹)</label><input type="number" step="0.01" style="padding:10px 15px; width:100%; border:1px solid #ddd;
                                   border-radius:6px; outline:none; font-size:14px;" name="allowances" placeholder="0.00" value="0"></div><div style="margin-bottom:15px;"><label style="font-weight:600; color:#333; font-size:14px;">Overtime Amount (₹)</label><input type="number" step="0.01" style="padding:10px 15px; width:100%; border:1px solid #ddd;
                                   border-radius:6px; outline:none; font-size:14px;" name="overtime_amount" placeholder="0.00" value="0"></div><div style="margin-bottom:15px;"><label style="font-weight:600; color:#333; font-size:14px;">Other Deductions (₹)</label><input type="number" step="0.01" style="padding:10px 15px; width:100%; border:1px solid #ddd;
                                   border-radius:6px; outline:none; font-size:14px;" name="other_deductions" placeholder="0.00" value="0"></div><div style="background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;padding:12px;border-radius:6px;margin-bottom:15px;"><small><i class="ri-information-line me-2"></i>
                                Deductions for absences, half-days, and late arrivals will be calculated automatically based on attendance data.
                            </small></div><button type="submit" style="background:#0b7368; color:#fff; border:none;
                               padding:12px 20px; border-radius:6px; font-size:16px; font-weight:600; width:100%;"><i class="ri-calculator-line me-2"></i>Calculate Payroll
                        </button></form></div></div></div><!-- Payroll Records --><div class="col-lg-8"><div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin:20px 0;"><div style="background:#0b7368;color:#fff;padding:15px;border-radius:10px 10px 0 0;"><h5 style="margin:0; font-weight:600;"><i class="ri-money-dollar-circle-line me-2"></i>
                        Payroll Records
                    </h5></div><div style="padding:20px;">
                    {% if payrolls %}
                        <div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; font-family:Poppins, sans-serif;"><thead style="background:#f8f9fa;"><tr><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Employee</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Period</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Base Salary</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Gross Salary</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Deductions</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Final Salary</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Status</th><th style="padding:12px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #dee2e6;">Actions</th></tr></thead><tbody>
                                    {% for payroll in payrolls %}
                                    <tr style="border-bottom:1px solid #dee2e6;"><td style="padding:12px;"><div style="display:flex; align-items:center;">
                                                {% if payroll.employee.image %}
                                                    <img src="{{ payroll.employee.image.url }}" alt="{{ payroll.employee.first_name }}" style="width:32px; height:32px; border-radius:50%; margin-right:8px; object-fit:cover;">
                                                {% else %}
                                                    <div style="width:32px; height:32px; border-radius:50%; background:#f8f9fa; display:flex; align-items:center; justify-content:center; margin-right:8px;"><i class="ri-user-line text-muted"></i></div>
                                                {% endif %}
                                                <div><div style="font-weight:600;">{{ payroll.employee.first_name }} {{ payroll.employee.last_name }}</div><div style="font-size:12px; color:#666;">{{ payroll.employee.company_id }}</div></div></div></td><td style="padding:12px;"><div style="font-weight:600;">{{ payroll.month }} {{ payroll.year }}</div><div style="font-size:12px; color:#666;">{{ payroll.employee.department }}</div></td><td style="padding:12px;">₹{{ payroll.base_salary }}</td><td style="padding:12px;">₹{{ payroll.gross_salary }}</td><td style="padding:12px;"><div style="font-size:12px;"><div><strong>₹{{ payroll.leave_deduction }}</strong> leave</div><div><strong>₹{{ payroll.half_day_deduction }}</strong> half-day</div><div><strong>₹{{ payroll.late_arrival_deduction }}</strong> late</div></div></td><td style="padding:12px;"><div style="font-weight:600; color:#28a745;">₹{{ payroll.final_salary }}</div></td><td style="padding:12px;">
                                            {% if payroll.is_processed %}
                                                <span style="background:#28a745; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px;"><i class="ri-check-double-line me-1"></i>Processed
                                                </span>
                                            {% else %}
                                                <span style="background:#ffc107; color:#000; padding:4px 8px; border-radius:4px; font-size:12px;"><i class="ri-time-line me-1"></i>Pending
                                                </span>
                                            {% endif %}
                                        </td><td style="padding:12px;">
                                            {% if not payroll.is_processed %}
                                                <form method="POST" style="display:inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="process_payroll"><input type="hidden" name="payroll_id" value="{{ payroll.id }}"><button type="submit" style="background:#28a745; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-size:12px; margin-right:8px;"><i class="ri-check-line"></i> Process
                                                    </button></form>
                                            {% endif %}
                                            <span style="background:#6c757d; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:not-allowed;" title="View functionality disabled"><i class="ri-eye-line"></i> View
                                            </span></td></tr>
                                    {% endfor %}
                                </tbody></table></div>
                    {% else %}
                        <div style="text-align:center; padding:40px;"><i class="ri-money-dollar-circle-line" style="font-size:48px; color:#ccc;"></i><div style="font-size:18px; color:#666; margin:15px 0;">No Payroll Records</div><div style="color:#999;">Calculate payroll for employees to see them here.</div></div>
                    {% endif %}
                </div></div></div></div><!-- Recent Activity --><div class="row"><div class="col-12"><div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin:20px 0;"><div style="background:#0b7368;color:#fff;padding:15px;border-radius:10px 10px 0 0;"><h6 style="margin:0; font-weight:600;"><i class="ri-history-line me-2"></i>
                        Recent Payroll Activity
                    </h6></div><div style="padding:20px;">
                    {% if recent_payrolls %}
                        <div class="row">
                            {% for payroll in recent_payrolls %}
                            <div class="col-md-6 col-lg-4"><div style="border:1px solid #dee2e6; border-radius:8px; padding:15px; margin-bottom:15px;"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><div style="font-weight:600;">{{ payroll.employee.first_name }} {{ payroll.employee.last_name }}</div><div style="color:#666; font-size:14px;">{{ payroll.month }} {{ payroll.year }}</div></div>
                                        {% if payroll.is_processed %}
                                            <span style="background:#28a745; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px;">Processed</span>
                                        {% else %}
                                            <span style="background:#ffc107; color:#000; padding:4px 8px; border-radius:4px; font-size:12px;">Pending</span>
                                        {% endif %}
                                    </div><div style="display:flex; justify-content:space-between; margin-top:10px;"><div><div style="font-size:12px; color:#666;">Base Salary</div><div style="font-weight:600;">₹{{ payroll.base_salary }}</div></div><div style="text-align:right;"><div style="font-size:12px; color:#666;">Final Salary</div><div style="font-weight:600; color:#28a745;">₹{{ payroll.final_salary }}</div></div></div></div></div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div style="text-align:center; padding:30px;"><i class="ri-history-line" style="font-size:48px; color:#ccc;"></i><div style="color:#999; margin-top:10px;">No recent payroll activity</div></div>
                    {% endif %}
                </div></div></div></div></main>

{% endblock %}