
{% extends "app/base.html" %}
{% block content %}



<!-- CONTENT --><main class="content-wrap"><div class="d-flex justify-content-between mb-3" style="background:rgb(250, 252, 252);border:1px solid #e5e7eb;padding:10px 15px;border-radius:4px;"><div class="page-title" style="color: teal;">Announcement Management</div><a href="/hr/dashboard.html"><div class="text" style="color: teal;">Dashboard</div></a></div><!-- STATISTICS INFO SECTION --><div style="border:2px solid #0a6d65; border-radius:10px; padding:15px; margin:20px 0; background:#f0f9ff;"><h5 style="color:#0a6d65; margin-bottom:10px;"><i class="fas fa-chart-bar me-2"></i>Announcement Statistics
    </h5><div style="display:flex; gap:20px; flex-wrap:wrap;"><div><strong>Total Announcements:</strong> {{ total_announcements }}<br><strong>Active Today:</strong> {{ active_today }}<br><strong>Total Views:</strong> {{ total_views }}
      </div><div><strong>Categories:</strong> {{ categories_count }}<br><strong>Published:</strong> {{ active_announcements }}<br><strong>Status:</strong> System Operational
      </div></div><div style="margin-top:10px; padding:8px; background:#e6f7ff; border-radius:5px;"><small><strong>Note:</strong> Use the Create button below to add new announcements</small></div></div><!-- ANNOUNCEMENT STATISTICS --><div style="display:flex; gap:20px; flex-wrap:wrap; margin:20px 0; font-family:Poppins, sans-serif;"><!-- CARD 1 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#1a73e8; margin-bottom:8px;"><i class="fa-solid fa-bullhorn"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ total_announcements }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Total Announcements</div></div><!-- CARD 2 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#0f8f5c; margin-bottom:8px;"><i class="fa-solid fa-clock"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ active_today }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Active Today</div></div><!-- CARD 3 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#e63946; margin-bottom:8px;"><i class="fa-solid fa-eye"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ total_views }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Total Views</div></div><!-- CARD 4 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#06b6d4; margin-bottom:8px;"><i class="fa-solid fa-users"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ categories_count }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Categories</div></div></div><!-- ANNOUNCEMENT FILTERS --><div style="border:2px solid #0b7368; border-radius:10px; padding:20px;
            font-family:Poppins, sans-serif; margin:20px 0;"><div style="display:flex; flex-wrap:wrap; align-items:center; gap:25px;"><!-- Category Filter --><div style="display:flex; flex-direction:column;"><label style="font-weight:600; color:#333; font-size:14px;">Category</label><select style="padding:10px 15px; width:220px; border:1px solid #ddd;
                           border-radius:6px; outline:none; font-size:14px;"><option>All Categories</option><option>Company News</option><option>HR Updates</option><option>Policy Changes</option><option>Events</option><option>General</option></select></div><!-- Priority Filter --><div style="display:flex; flex-direction:column;"><label style="font-weight:600; color:#333; font-size:14px;">Priority</label><select style="padding:10px 15px; width:220px; border:1px solid #ddd;
                           border-radius:6px; outline:none; font-size:14px;"><option>All Priorities</option><option>High</option><option>Medium</option><option>Low</option></select></div><!-- Date Range --><div style="display:flex; flex-direction:column;"><label style="font-weight:600; color:#333; font-size:14px;">Date Range</label><input type="date"
                   style="padding:10px 15px; width:220px; border:1px solid #ddd;
                          border-radius:6px; outline:none; font-size:14px;" /></div><!-- SEARCH BOX WITH ICON INSIDE --><div style="display:flex; flex-direction:column; position:relative;"><label style="font-weight:600; color:#333; font-size:14px;">Search</label><input type="text" placeholder="Search announcements..."
                   style="padding:10px 45px 10px 15px; width:220px; border:1px solid #ddd;
                          border-radius:6px; outline:none; font-size:14px;" /><!-- Icon inside box (Right side) --><i class="fa-solid fa-magnifying-glass"
               style="position:absolute; right:12px; top:38px; color:#777;
                      font-size:14px;"></i></div><!-- Buttons --><div style="margin-left:auto; display:flex; gap:12px;"><!-- Create Announcement Button --><button data-bs-toggle="modal" data-bs-target="#createAnnouncementModal"
                    style="background:#0a6d65; color:#fff; border:none;
                           padding:10px 22px; border-radius:6px; font-size:16px; font-weight:600;"><i class="fa-solid fa-plus me-2"></i>Create
            </button><!-- Export Button --><button style="background:#34a853; color:#fff; border:none;
                           padding:10px 22px; border-radius:6px; font-size:18px;"><i class="fa-solid fa-download"></i></button></div></div></div><!-- ANNOUNCEMENT LIST --><div style="background:#ffffff; border-radius:10px; box-shadow:0px 2px 6px rgba(0,0,0,0.08); 
            border:1px solid #e5e7eb; overflow:hidden; margin-top:20px;"><!-- Table Header --><div style="padding:20px; border-bottom:1px solid #e5e7eb;"><div class="d-flex justify-content-between align-items-center"><h5 style="margin:0; font-weight:600; color:#333;">Recent Announcements</h5><div class="btn-group" role="group"><button type="button" class="btn btn-outline-secondary btn-sm active" id="listViewBtn"><i class="fas fa-list"></i> List
                </button><button type="button" class="btn btn-outline-secondary btn-sm" id="cardViewBtn"><i class="fas fa-th-large"></i> Cards
                </button></div></div></div><!-- Responsive Table/List View --><div class="table-responsive" id="listView"><table class="table table-hover mb-0" style="font-family:Poppins, sans-serif;"><thead style="background:#f8f9fa;"><tr><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Title</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Category</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Priority</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Date</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Views</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Status</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Actions</th></tr></thead><tbody id="announcementTableBody"><!-- Dynamic Announcement Data -->
                {% for announcement in announcements %}
                <tr><td class="px-4 py-3" style="font-size:14px; color:#333; font-weight:600;">{{ announcement.title }}</td><td class="px-4 py-3">
                        {% if announcement.category == "company_news" %}
                            <span class="badge bg-primary">Company News</span>
                        {% elif announcement.category == "hr_updates" %}
                            <span class="badge bg-info">HR Updates</span>
                        {% elif announcement.category == "policy_changes" %}
                            <span class="badge bg-danger">Policy Changes</span>
                        {% elif announcement.category == "events" %}
                            <span class="badge bg-warning text-dark">Events</span>
                        {% elif announcement.category == "general" %}
                            <span class="badge bg-secondary">General</span>
                        {% elif announcement.category == "holiday" %}
                            <span class="badge bg-warning text-dark">Holiday Notice</span>
                        {% elif announcement.category == "training" %}
                            <span class="badge bg-info">Training & Development</span>
                        {% elif announcement.category == "awards" %}
                            <span class="badge bg-success">Awards & Recognition</span>
                        {% elif announcement.category == "technology" %}
                            <span class="badge bg-primary">Technology Updates</span>
                        {% elif announcement.category == "facilities" %}
                            <span class="badge bg-secondary">Facilities & Infrastructure</span>
                        {% elif announcement.category == "safety" %}
                            <span class="badge bg-warning text-dark">Safety & Security</span>
                        {% elif announcement.category == "compliance" %}
                            <span class="badge bg-danger">Compliance & Legal</span>
                        {% elif announcement.category == "financial" %}
                            <span class="badge bg-success">Financial Updates</span>
                        {% elif announcement.category == "product" %}
                            <span class="badge bg-primary">Product Updates</span>
                        {% elif announcement.category == "marketing" %}
                            <span class="badge bg-info">Marketing & Sales</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ announcement.category }}</span>
                        {% endif %}
                    </td><td class="px-4 py-3">
                        {% if announcement.priority == "high" %}
                            <span class="badge bg-danger">High</span>
                        {% elif announcement.priority == "medium" %}
                            <span class="badge bg-warning text-dark">Medium</span>
                        {% elif announcement.priority == "low" %}
                            <span class="badge bg-secondary">Low</span>
                        {% elif announcement.priority == "critical" %}
                            <span class="badge bg-danger">Critical</span>
                        {% elif announcement.priority == "urgent" %}
                            <span class="badge bg-danger">Urgent</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ announcement.priority }}</span>
                        {% endif %}
                    </td><td class="px-4 py-3" style="font-size:14px; color:#333;">{{ announcement.created_at|date:"M d, Y" }}</td><td class="px-4 py-3" style="font-size:14px; color:#333; font-weight:600;">{{ announcement.read_by_count }}</td><td class="px-4 py-3">
                        {% if announcement.status == "published" %}
                            <span class="badge bg-success">Active</span>
                        {% elif announcement.status == "draft" %}
                            <span class="badge bg-warning text-dark">Draft</span>
                        {% elif announcement.status == "scheduled" %}
                            <span class="badge bg-info">Scheduled</span>
                        {% elif announcement.status == "expired" %}
                            <span class="badge bg-secondary">Expired</span>
                        {% elif announcement.status == "archived" %}
                            <span class="badge bg-secondary">Archived</span>
                        {% elif announcement.status == "withdrawn" %}
                            <span class="badge bg-danger">Withdrawn</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ announcement.status }}</span>
                        {% endif %}
                    </td><td class="px-4 py-3"><!-- View Button --><button class="btn btn-sm btn-outline-primary me-1" title="View" 
                                data-bs-toggle="modal" data-bs-target="#announcementDetailsModal"
                                onclick="loadAnnouncementDetails({{ announcement.id }})"><i class="fas fa-eye"></i></button><!-- Edit Button --><a href="{% url 'edit-announcement' announcement.id %}" 
                           class="btn btn-sm btn-outline-secondary me-1" title="Edit"><i class="fas fa-edit"></i></a><!-- Delete Button with Confirmation --><form method="POST" action="{% url 'delete-announcement' announcement.id %}" 
                              style="display: inline;" 
                              onsubmit="return confirm('Are you sure you want to delete this announcement?\n\nTitle: {{ announcement.title }}\n\nThis action cannot be undone.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash"></i></button></form></td></tr>
                {% empty %}
                <tr><td colspan="7" class="px-4 py-3 text-center" style="color:#666; font-style:italic;">
                        No announcements found. Create your first announcement using the "Create" button above.
                    </td></tr>
                {% endfor %}
            </tbody></table></div><!-- Card View (Hidden by default) --><div class="p-4" id="cardView" style="display:none;"><div class="row g-4" id="announcementCards"><!-- Card view content will be added by JavaScript --></div></div></div><!-- CREATE ANNOUNCEMENT MODAL --><div class="modal fade" id="createAnnouncementModal" tabindex="-1" aria-labelledby="createAnnouncementModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content" style="border:none; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.15);"><div class="modal-header" style="background:linear-gradient(135deg, #0a6d65 0%, #1a7370 100%); color:white; border-radius:15px 15px 0 0; border:none;"><h5 class="modal-title fw-bold" id="createAnnouncementModalLabel"><i class="fas fa-bullhorn me-2"></i>Create New Announcement
                </h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-4"><form id="createAnnouncementForm" method="POST" action="{% url 'hr-announcements' %}" onsubmit="console.log('FORM SUBMITTED!'); return true;">
    {% csrf_token %}
    <div class="row"><div class="col-md-6"><div class="mb-3"><label for="announcementTitle" class="form-label fw-bold">
                    Title <span class="text-danger">*</span></label><input type="text" class="form-control"
                       id="announcementTitle" name="announcementTitle" required
                       style="border:1px solid #ddd; border-radius:8px; padding:10px;"></div></div><div class="col-md-6"><div class="mb-3"><label for="announcementCategory" class="form-label fw-bold">
                    Category <span class="text-danger">*</span></label><select class="form-select" id="announcementCategory" name="announcementCategory" required
                        style="border:1px solid #ddd; border-radius:8px; padding:10px;"><option value="">Select Category</option><option value="company_news">Company News</option><option value="hr_updates">HR Updates</option><option value="policy_changes">Policy Changes</option><option value="events">Events</option><option value="general">General</option><option value="holiday">Holiday Notice</option><option value="training">Training & Development</option><option value="awards">Awards & Recognition</option><option value="technology">Technology Updates</option><option value="facilities">Facilities & Infrastructure</option><option value="safety">Safety & Security</option><option value="compliance">Compliance & Legal</option><option value="financial">Financial Updates</option><option value="product">Product Updates</option><option value="marketing">Marketing & Sales</option></select></div></div></div><div class="row"><div class="col-md-6"><div class="mb-3"><label for="announcementPriority" class="form-label fw-bold">
                    Priority <span class="text-danger">*</span></label><select class="form-select" id="announcementPriority" name="announcementPriority" required
                        style="border:1px solid #ddd; border-radius:8px; padding:10px;"><option value="">Select Priority</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option><option value="critical">Critical</option><option value="urgent">Urgent</option></select></div></div><div class="col-md-6"><div class="mb-3"><label for="announcementExpiry" class="form-label fw-bold">Expiry Date</label><input type="date" class="form-control" id="announcementExpiry" name="announcementExpiry"
                       style="border:1px solid #ddd; border-radius:8px; padding:10px;"></div></div></div><div class="mb-3"><label for="announcementContent" class="form-label fw-bold">
            Content <span class="text-danger">*</span></label><textarea class="form-control" id="announcementContent" name="announcementContent"
                  rows="6" required
                  placeholder="Enter announcement content..."
                  style="border:1px solid #ddd; border-radius:8px; padding:10px; resize:vertical;"></textarea></div><div class="mb-3"><label class="form-label fw-bold">Target Audience</label><div class="mt-2"><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                       id="allEmployees" name="allEmployees" value="all" checked><label class="form-check-label" for="allEmployees">All Employees</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                       id="management" name="management" value="management"><label class="form-check-label" for="management">Management</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox"
                       id="departments" name="departments" value="departments"><label class="form-check-label" for="departments">Specific Departments</label></div></div></div></form></div><div class="modal-footer border-0 pt-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius:8px; padding:8px 20px; font-weight:500;">
                    Cancel
                </button><button type="submit" form="createAnnouncementForm" class="btn btn-primary"
                        style="border-radius:8px; padding:8px 20px; font-weight:500; background:#0a6d65; border-color:#0a6d65;"><i class="fas fa-paper-plane me-1"></i>Publish Announcement
                </button></div></div></div></div><!-- ANNOUNCEMENT DETAILS MODAL --><div class="modal fade" id="announcementDetailsModal" tabindex="-1" aria-labelledby="announcementDetailsModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><br><br><br><div class="modal-content" style="border:none; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.15);"><div class="modal-header" style="background:linear-gradient(135deg, #0a6d65 0%, #1a7370 100%); color:white; border-radius:15px 15px 0 0; border:none;"><h5 class="modal-title fw-bold" id="announcementDetailsModalLabel"><i class="fas fa-eye me-2"></i>Announcement Details
                </h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-4"><div id="announcementModalContent"><div id="loadingContent" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading announcement details...</p></div><div id="announcementDetails" style="display: none;"><div class="row mb-3"><div class="col-md-8"><h4 id="modalTitle" class="fw-bold"></h4><p id="modalSummary" class="text-muted"></p></div><div class="col-md-4 text-end"><span id="modalCategory" class="badge fs-6 me-2"></span><span id="modalPriority" class="badge fs-6"></span></div></div><div class="row mb-3"><div class="col-md-6"><strong>Status:</strong><span id="modalStatus" class="badge"></span></div><div class="col-md-6"><strong>Views:</strong><span id="modalViews"></span></div></div><div class="row mb-3"><div class="col-md-6"><strong>Created By:</strong><span id="modalAuthor"></span></div><div class="col-md-6"><strong>Created Date:</strong><span id="modalCreatedDate"></span></div></div><div class="mb-3"><strong>Content:</strong><div id="modalContent" class="mt-2 p-3" style="background:#f8f9fa; border-radius:8px; border-left:4px solid #0a6d65;"></div></div><div class="row mb-3"><div class="col-md-6"><strong>Publish Date:</strong><span id="modalPublishDate"></span></div><div class="col-md-6"><strong>Expiry Date:</strong><span id="modalExpiryDate"></span></div></div><div class="row"><div class="col-md-6"><strong>Target Audience:</strong><span id="modalAudience"></span></div><div class="col-md-6"><strong>Likes:</strong><span id="modalLikes"></span></div></div></div><div id="errorContent" class="text-center" style="display: none;"><div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i><span id="errorMessage">Failed to load announcement details.</span></div></div></div></div><div class="modal-footer border-0 pt-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius:8px; padding:8px 20px; font-weight:500;">
                    Close
                </button></div></div></div></div></main><!-- Temporary Success Message --><div id="tempSuccessMessage" class="alert alert-success position-fixed" 
     style="top: 20px; right: 20px; z-index: 9999; display: none; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; 
            border-left: 5px solid #28a745; min-width: 300px;"><i class="fas fa-check-circle me-2"></i><span id="successText">Announcement sent to employees successfully!</span></div><!-- JavaScript for Temporary Success Message and Form Validation --><script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Announcement page loaded');
    
    // Check if there's a temporary success message from the server
    {% if temp_success_message %}
        showTempSuccessMessage("{{ temp_success_message|escapejs }}");
    {% endif %}
    
    // Check if there's a temporary error message from the server
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                console.error('‚ùå Server error message:', "{{ message|escapejs }}");
                showTempErrorMessage("{{ message|escapejs }}");
            {% endif %}
        {% endfor %}
    {% endif %}
});

function showTempSuccessMessage(message) {
    console.log('üéâ Showing success message:', message);
    const messageDiv = document.getElementById('tempSuccessMessage');
    const successText = document.getElementById('successText');
    
    // Set the message text
    successText.textContent = message;
    
    // Show the message
    messageDiv.style.display = 'block';
    
    // Hide after 3 seconds
    setTimeout(function() {
        messageDiv.style.display = 'none';
    }, 3000);
}

function showTempErrorMessage(message) {
    console.error('‚ùå Showing error message:', message);
    // Create error message element
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger position-fixed';
    errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; border-left: 5px solid #dc3545; min-width: 300px;';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i><span>${message}</span>`;
    document.body.appendChild(errorDiv);
    
    // Hide after 5 seconds
    setTimeout(function() {
        errorDiv.remove();
    }, 5000);
}

function validateAndSubmitForm() {
    console.log('üîç Form submission triggered');
    
    // Get form fields
    const title = document.getElementById('announcementTitle').value.trim();
    const category = document.getElementById('announcementCategory').value.trim();
    const priority = document.getElementById('announcementPriority').value.trim();
    const content = document.getElementById('announcementContent').value.trim();
    const expiryDate = document.getElementById('announcementExpiry').value;
    
    console.log('üìã Form data collected:');
    console.log('  Title:', title);
    console.log('  Category:', category);
    console.log('  Priority:', priority);
    console.log('  Content length:', content.length);
    console.log('  Expiry Date:', expiryDate);
    
    // Client-side validation
    const errors = [];
    if (!title) errors.push('Title is required');
    if (!category) errors.push('Category is required');
    if (!priority) errors.push('Priority is required');
    if (!content) errors.push('Content is required');
    
    if (errors.length> 0) {
        console.error('‚ùå Client validation failed:', errors);
        alert('Please fix the following errors:\n- ' + errors.join('\n- '));
        return false;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[form="createAnnouncementForm"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Publishing...';
    submitBtn.disabled = true;
    
    console.log('‚úÖ Client validation passed, form will be submitted');
    
    // Form will be submitted normally
    return true;
}

// Log all form submissions
document.getElementById('createAnnouncementForm').addEventListener('submit', function(e) {
    console.log('üìù Form submit event triggered');
    console.log('Form action:', this.action);
    console.log('Form method:', this.method);
});

// Form submission handler with improved UX
function handleFormSubmit() {
    const submitBtn = document.querySelector('button[form="createAnnouncementForm"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Publishing...';
    submitBtn.disabled = true;
    
    // The form will submit normally, loading state will be reset on page reload
    return true;
}

// Load announcement details for modal
function loadAnnouncementDetails(announcementId) {
    console.log('Loading announcement details for ID:', announcementId);
    
    // Show loading state
    document.getElementById('loadingContent').style.display = 'block';
    document.getElementById('announcementDetails').style.display = 'none';
    document.getElementById('errorContent').style.display = 'none';
    
    // Fetch announcement details
    fetch(`/announcements/view/${announcementId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Populate modal with announcement data
                document.getElementById('modalTitle').textContent = data.title;
                document.getElementById('modalSummary').textContent = data.summary || '';
                
                // Set category badge
                const categoryElement = document.getElementById('modalCategory');
                categoryElement.textContent = data.category;
                categoryElement.className = 'badge fs-6 me-2';
                
                // Set priority badge
                const priorityElement = document.getElementById('modalPriority');
                priorityElement.textContent = data.priority;
                priorityElement.className = 'badge fs-6';
                
                // Set status badge
                const statusElement = document.getElementById('modalStatus');
                statusElement.textContent = data.status;
                statusElement.className = 'badge';
                
                // Add appropriate classes based on status
                if (data.status === 'Active') {
                    statusElement.classList.add('bg-success');
                } else if (data.status === 'Draft') {
                    statusElement.classList.add('bg-warning', 'text-dark');
                } else if (data.status === 'Scheduled') {
                    statusElement.classList.add('bg-info');
                } else {
                    statusElement.classList.add('bg-secondary');
                }
                
                // Add appropriate classes for category
                const category = data.category.toLowerCase();
                if (category.includes('company') || category.includes('technology') || category.includes('product')) {
                    categoryElement.classList.add('bg-primary');
                } else if (category.includes('hr') || category.includes('training') || category.includes('marketing')) {
                    categoryElement.classList.add('bg-info');
                } else if (category.includes('policy') || category.includes('compliance')) {
                    categoryElement.classList.add('bg-danger');
                } else if (category.includes('events') || category.includes('holiday') || category.includes('safety')) {
                    categoryElement.classList.add('bg-warning', 'text-dark');
                } else if (category.includes('awards') || category.includes('financial')) {
                    categoryElement.classList.add('bg-success');
                } else {
                    categoryElement.classList.add('bg-secondary');
                }
                
                // Add appropriate classes for priority
                const priority = data.priority.toLowerCase();
                if (priority === 'high' || priority === 'critical' || priority === 'urgent') {
                    priorityElement.classList.add('bg-danger');
                } else if (priority === 'medium') {
                    priorityElement.classList.add('bg-warning', 'text-dark');
                } else {
                    priorityElement.classList.add('bg-secondary');
                }
                
                document.getElementById('modalViews').textContent = data.read_by_count;
                document.getElementById('modalAuthor').textContent = data.created_by;
                document.getElementById('modalCreatedDate').textContent = data.created_at;
                document.getElementById('modalContent').innerHTML = data.content.replace(/\n/g, '<br>');
                document.getElementById('modalPublishDate').textContent = data.publish_date;
                document.getElementById('modalExpiryDate').textContent = data.expiry_date;
                document.getElementById('modalAudience').textContent = data.target_audience;
                document.getElementById('modalLikes').textContent = data.likes_count;
                
                // Hide loading, show content
                document.getElementById('loadingContent').style.display = 'none';
                document.getElementById('announcementDetails').style.display = 'block';
            } else {
                throw new Error(data.error || 'Failed to load announcement details');
            }
        })
        .catch(error => {
            console.error('Error loading announcement details:', error);
            document.getElementById('loadingContent').style.display = 'none';
            document.getElementById('errorContent').style.display = 'block';
            document.getElementById('errorMessage').textContent = error.message || 'Failed to load announcement details.';
        });
}

// Table/Card view toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const listViewBtn = document.getElementById('listViewBtn');
    const cardViewBtn = document.getElementById('cardViewBtn');
    const listView = document.getElementById('listView');
    const cardView = document.getElementById('cardView');
    
    if (listViewBtn && cardViewBtn) {
        listViewBtn.addEventListener('click', function() {
            // Show list view, hide card view
            listView.style.display = 'block';
            cardView.style.display = 'none';
            
            // Update button states
            listViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
            
            console.log('Switched to list view');
        });
        
        cardViewBtn.addEventListener('click', function() {
            // Show card view, hide list view
            listView.style.display = 'none';
            cardView.style.display = 'block';
            
            // Update button states
            cardViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            
            // Generate card view content
            generateCardView();
            console.log('Switched to card view');
        });
    }
    
    function generateCardView() {
        const cardContainer = document.getElementById('announcementCards');
        if (!cardContainer) return;
        
        // Get announcement data from the table rows
        const tableRows = document.querySelectorAll('#announcementTableBody tr');
        cardContainer.innerHTML = '';
        
        tableRows.forEach(row => {
            const title = row.cells[0]?.textContent.trim();
            const category = row.cells[1]?.innerHTML;
            const priority = row.cells[2]?.innerHTML;
            const date = row.cells[3]?.textContent.trim();
            const views = row.cells[4]?.textContent.trim();
            const status = row.cells[5]?.innerHTML;
            const actions = row.cells[6]?.innerHTML;
            
            if (title && title !== 'No announcements found') {
                const cardHtml = `
                    <div class="col-md-6 col-lg-4"><div class="card h-100 border-0 shadow-sm"><div class="card-body"><div class="d-flex justify-content-between align-items-start mb-2"><h6 class="card-title fw-bold text-truncate" style="max-width: 200px;" title="${title}">${title}</h6><small class="text-muted">${date}</small></div><div class="mb-2">
                                    ${category}
                                    ${priority}
                                </div><div class="mb-2"><small class="text-muted"><i class="fas fa-eye me-1"></i>${views} views
                                    </small></div><div class="mb-3">
                                    ${status}
                                </div><div class="mt-auto"><div class="btn-group w-100" role="group">
                                        ${actions}
                                    </div></div></div></div></div>
                `;
                cardContainer.innerHTML += cardHtml;
            }
        });
    }
});
</script>

{% endblock %}
