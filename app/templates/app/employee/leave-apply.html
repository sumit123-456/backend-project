{% extends 'app/base2.html' %}
{% block content %}



<!-- CONTENT --><main class="content-wrap"><div class="d-flex justify-content-between mb-3" style="background:#fff;border:1px solid #e5e7eb;padding:10px 15px;border-radius:4px;"><div class="page-title">Apply Leave</div><a href="{% url 'employee-dashboard' %}"><div class="text-muted">Dashboard</div></a></div><!-- LEAVE BALANCE STATISTICS --><div style="display:flex; gap:20px; flex-wrap:wrap; margin:20px 0; font-family:Poppins, sans-serif;"><!-- CARD 1 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#1a73e8; margin-bottom:8px;"><i class="fa-solid fa-calendar-days"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ remaining_leaves }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Available This Month</div><div style="font-size:12px; color:#28a745; margin-top:4px;">Days remaining</div></div><!-- CARD 2 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#f2b33d; margin-bottom:8px;"><i class="fa-solid fa-user-md"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ leaves_taken_this_month }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Used This Month</div><div style="font-size:12px; color:#f2b33d; margin-top:4px;">Days taken</div></div><!-- CARD 3 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#e63946; margin-bottom:8px;"><i class="fa-solid fa-clock"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ total_pending }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Pending Requests</div><div style="font-size:12px; color:#f2b33d; margin-top:4px;">Awaiting approval</div></div><!-- CARD 4 --><div style="flex:1; min-width:220px; background:#ffffff; border-radius:10px;
                border-top:6px solid #0a6d65; padding:25px; text-align:center;
                box-shadow:0px 2px 6px rgba(0,0,0,0.08);"><div style="font-size:38px; color:#06b6d4; margin-bottom:8px;"><i class="fa-solid fa-check-circle"></i></div><div style="font-size:32px; font-weight:700; color:#000;">{{ total_approved }}</div><div style="font-size:15px; color:#666; margin-top:4px;">Total Approved</div><div style="font-size:12px; color:#28a745; margin-top:4px;">Requests approved</div></div></div><!-- LEAVE APPLICATION FORM --><div style="background:#ffffff; border-radius:10px; box-shadow:0px 2px 6px rgba(0,0,0,0.08); 
            border:1px solid #e5e7eb; overflow:hidden; margin:20px 0;"><!-- Form Header --><div style="padding:20px; border-bottom:1px solid #e5e7eb;background-color: #0a6d65;"><h5 style="margin:0; font-weight:600; color:#f5f3f3;"><i class="fas fa-calendar-plus me-2"></i><span>New Leave Request</span></h5></div><!-- Form Content --><div style="padding:30px;"><form method="POST">
            {% csrf_token %}
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
                {% endfor %}
            {% endif %}
            
            {% if remaining_leaves <= 0 %}
                <div class="alert alert-warning" role="alert"><strong>Monthly Leave Limit Reached:</strong> You have already used {{ leaves_taken_this_month }} days of leave this month (maximum {{ max_leaves_per_month }} days allowed).
                </div>
            {% endif %}
            
            <!-- Hidden input to identify the action --><input type="hidden" name="action" value="submit" id="formAction"><div class="row g-4"><!-- Leave Type --><div class="col-md-6"><label for="leave_type" class="form-label fw-bold">Leave Type</label><select name="leave_type" class="form-select" required style="border:1px solid #ddd; border-radius:8px; padding:12px;" {% if remaining_leaves <= 0 %}disabled{% endif %}><option value="">Select Leave Type</option><option value="annual">Annual Leave</option><option value="sick">Sick Leave</option><option value="casual">Casual Leave</option><option value="emergency">Emergency Leave</option><option value="maternity">Maternity Leave</option><option value="paternity">Paternity Leave</option><option value="unpaid">Unpaid Leave</option></select></div><!-- Start Date --><div class="col-md-6"><label for="start_date" class="form-label fw-bold">Start Date</label><input type="date" name="start_date" class="form-control" required 
                           style="border:1px solid #ddd; border-radius:8px; padding:12px;" 
                           min="{{ timezone.now.date }}" {% if remaining_leaves <= 0 %}disabled{% endif %} /></div><!-- End Date --><div class="col-md-6"><label for="end_date" class="form-label fw-bold">End Date</label><input type="date" name="end_date" class="form-control" required 
                           style="border:1px solid #ddd; border-radius:8px; padding:12px;" 
                           min="{{ timezone.now.date }}" {% if remaining_leaves <= 0 %}disabled{% endif %} /></div><!-- Reason --><div class="col-12"><label for="reason" class="form-label fw-bold">Reason for Leave</label><textarea name="reason" class="form-control" rows="4" required
                              style="border:1px solid #ddd; border-radius:8px; padding:12px; resize:vertical;"
                              placeholder="Please provide a detailed reason for your leave request..." {% if remaining_leaves <= 0 %}disabled{% endif %}></textarea></div><!-- Contact Information --><div class="col-12"><label for="contact_details" class="form-label fw-bold">Contact Information (Optional)</label><input type="text" name="contact_details" class="form-control"
                           style="border:1px solid #ddd; border-radius:8px; padding:12px;"
                           placeholder="Provide contact details if you'll be reachable during leave" {% if remaining_leaves <= 0 %}disabled{% endif %} /></div><!-- Emergency Contact --><div class="col-12"><label for="emergency_contact" class="form-label fw-bold">Emergency Contact (Optional)</label><input type="text" name="emergency_contact" class="form-control"
                           style="border:1px solid #ddd; border-radius:8px; padding:12px;"
                           placeholder="Name and phone number of emergency contact" {% if remaining_leaves <= 0 %}disabled{% endif %} /></div></div><!-- Form Actions --><div class="row mt-5"><div class="col-12"><div style="display:flex; gap:15px; justify-content:flex-end; flex-wrap: wrap;"><button type="reset" 
                                style="background:#6c757d; color:#fff; border:none;
                                       padding:12px 24px; border-radius:8px; font-weight:600; 
                                       font-size:14px;" {% if remaining_leaves <= 0 %}disabled{% endif %}><i class="fa-solid fa-rotate-left me-2"></i><span>Reset</span></button><button type="submit" 
                                style="background:#0a6d65; color:#fff; border:none;
                                       padding:12px 24px; border-radius:8px; font-weight:600; 
                                       font-size:14px;" {% if remaining_leaves <= 0 %}disabled{% endif %}><i class="fa-solid fa-paper-plane me-2"></i><span>Submit Request</span></button></div></div></div></form></div></div><!-- LEAVE HISTORY --><div style="background:#ffffff; border-radius:10px; box-shadow:0px 2px 6px rgba(0,0,0,0.08); 
            border:1px solid #e5e7eb; overflow:hidden; margin-top:20px;"><!-- History Header --><div style="padding:20px; border-bottom:1px solid #e5e7eb;background-color: #0a6d65;"><div class="d-flex justify-content-between align-items-center"><h5 style="margin:0; font-weight:600; color:#f5f3f3;"><i class="fas fa-history me-2"></i><span>Leave History</span></h5></div></div><!-- History Filters --><div style="padding:20px; border-bottom:1px solid #e5e7eb; background:#f8f9fa;"><div style="display:flex; flex-wrap:wrap; align-items:center; gap:20px;"><!-- Year Filter --><div style="display:flex; flex-direction:column;"><label style="font-weight:600; color:#333; font-size:14px;">Year</label><select style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px;"><option>2024</option><option>2023</option><option>2022</option></select></div><!-- Leave Type Filter --><div style="display:flex; flex-direction:column;"><label style="font-weight:600; color:#333; font-size:14px;">Leave Type</label><select style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px;"><option>All Types</option><option>Annual Leave</option><option>Sick Leave</option><option>Personal Leave</option></select></div><!-- Search --><div style="display:flex; flex-direction:column; position:relative;"><label style="font-weight:600; color:#333; font-size:14px;">Search</label><input type="text" placeholder="Search by reason or date..." 
                       style="padding:8px 35px 8px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px;" /><i class="fa-solid fa-magnifying-glass" 
                   style="position:absolute; right:10px; top:32px; color:#777; font-size:12px;"></i></div></div></div><!-- History Table --><div class="table-responsive"><table class="table table-hover mb-0" style="font-family:Poppins, sans-serif;"><thead style="background:#f8f9fa;"><tr><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Applied On</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Leave Type</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Start Date</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">End Date</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Days</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Reason</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Status</th><th class="px-4 py-3" style="font-weight:600; color:#333; font-size:14px;">Action</th></tr></thead><tbody>
                {% for leave in recent_leaves %}
                <tr><td class="px-4 py-3">{{ leave.applied_at|date:"Y-m-d" }}</td><td class="px-4 py-3">{{ leave.get_leave_type_display }}</td><td class="px-4 py-3">{{ leave.start_date|date:"Y-m-d" }}</td><td class="px-4 py-3">{{ leave.end_date|date:"Y-m-d" }}</td><td class="px-4 py-3">{{ leave.total_days }}</td><td class="px-4 py-3"><div style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="{{ leave.reason }}">
                            {{ leave.reason|truncatechars:50 }}
                        </div></td><td class="px-4 py-3">
                        {% if leave.status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                        {% elif leave.status == 'pending' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% elif leave.status == 'rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ leave.status|title }}</span>
                        {% endif %}
                    </td><td class="px-4 py-3"><button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#leaveDetailsModal{{ leave.id }}"><i class="fas fa-eye"></i></button>
                        {% if leave.status == 'pending' %}
                        <form method="POST" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="cancel"><input type="hidden" name="leave_id" value="{{ leave.id }}"><button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to cancel this leave request?')"><i class="fas fa-times"></i></button></form>
                        {% endif %}
                    </td></tr><!-- Leave Details Modal for each leave --><div class="modal fade" id="leaveDetailsModal{{ leave.id }}" tabindex="-1" aria-labelledby="leaveDetailsModalLabel{{ leave.id }}" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content" style="border:none; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.15);"><div class="modal-header" style="background:linear-gradient(135deg, #0a6d65 0%, #1a7370 100%); color:white; border-radius:15px 15px 0 0; border:none;"><h5 class="modal-title fw-bold" id="leaveDetailsModalLabel{{ leave.id }}"><i class="fas fa-calendar-alt me-2"></i>Leave Request Details
                                </h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-4"><div class="row"><div class="col-md-6"><h6 class="fw-bold">Leave Information</h6><p><strong>Leave Type:</strong> {{ leave.get_leave_type_display }}</p><p><strong>Start Date:</strong> {{ leave.start_date|date:"F d, Y" }}</p><p><strong>End Date:</strong> {{ leave.end_date|date:"F d, Y" }}</p><p><strong>Total Days:</strong> {{ leave.total_days }}</p><p><strong>Applied On:</strong> {{ leave.applied_at|date:"F d, Y" }}</p></div><div class="col-md-6"><h6 class="fw-bold">Status Information</h6><p><strong>Current Status:</strong> 
                                            {% if leave.status == 'approved' %}
                                                <span class="badge bg-success">Approved</span>
                                            {% elif leave.status == 'pending' %}
                                                <span class="badge bg-warning text-dark">Pending</span>
                                            {% elif leave.status == 'rejected' %}
                                                <span class="badge bg-danger">Rejected</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ leave.status|title }}</span>
                                            {% endif %}
                                        </p>
                                        {% if leave.approved_by %}
                                            <p><strong>Approved By:</strong> {{ leave.approved_by }}</p><p><strong>Approval Date:</strong> {{ leave.approval_date|date:"F d, Y" }}</p>
                                        {% endif %}
                                        {% if leave.tl_approved %}
                                            <p><strong>Team Leader:</strong> {{ leave.tl_approved_by }}</p><p><strong>TL Approval:</strong> {{ leave.tl_approval_date|date:"F d, Y" }}</p>
                                        {% endif %}
                                    </div></div><div class="row mt-3"><div class="col-12"><h6 class="fw-bold">Reason</h6><p>{{ leave.reason|linebreaks }}</p></div></div>
                                {% if leave.contact_details %}
                                <div class="row mt-3"><div class="col-12"><h6 class="fw-bold">Contact Information</h6><p>{{ leave.contact_details }}</p></div></div>
                                {% endif %}
                                {% if leave.emergency_contact %}
                                <div class="row mt-3"><div class="col-12"><h6 class="fw-bold">Emergency Contact</h6><p>{{ leave.emergency_contact }}</p></div></div>
                                {% endif %}
                                {% if leave.tl_comments %}
                                <div class="row mt-3"><div class="col-12"><h6 class="fw-bold">Team Leader Comments</h6><p>{{ leave.tl_comments }}</p></div></div>
                                {% endif %}
                                {% if leave.hr_comments %}
                                <div class="row mt-3"><div class="col-12"><h6 class="fw-bold">HR Comments</h6><p>{{ leave.hr_comments }}</p></div></div>
                                {% endif %}
                                {% if leave.rejection_reason %}
                                <div class="row mt-3"><div class="col-12"><h6 class="fw-bold">Rejection Reason</h6><p>{{ leave.rejection_reason }}</p></div></div>
                                {% endif %}
                            </div><div class="modal-footer border-0 pt-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                                        style="border-radius:8px; padding:8px 20px; font-weight:500;">
                                    Close
                                </button></div></div></div></div>
                {% empty %}
                <tr><td colspan="8" class="px-4 py-5 text-center"><div style="color:#6c757d;"><i class="fas fa-calendar-times fa-3x mb-3"></i><p class="mb-0">No leave applications found.</p><small>Your leave history will appear here once you submit requests.</small></div></td></tr>
                {% endfor %}
            </tbody></table></div></div><!-- PAGINATION CONTROLS --><div class="d-flex justify-content-between align-items-center mt-3" id="paginationControls"><div class="d-flex align-items-center gap-3"><div><label for="recordsPerPage" class="form-label mb-0 me-2">Records per page:</label><select id="recordsPerPage" class="form-select form-select-sm" style="width: auto; display: inline-block;"><option value="5">5</option><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option></select></div><div id="recordInfo" class="text-muted small">Showing 1-8 of 8 records</div></div><nav aria-label="Leave history pagination"><ul class="pagination pagination-sm mb-0" id="pagination"><!-- Pagination items will be generated by JavaScript --></ul></nav></div></main><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script><script>

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const profileDropdown = document.querySelector('.profile-dropdown');
    const dropdownContent = document.getElementById('profileDropdown');
    
    if (!profileDropdown.contains(event.target)) {
        dropdownContent.classList.remove('show');
    }
});

// Calculate total days between dates
function calculateTotalDays() {
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    
    if (startDate && endDate && startDate <= endDate) {
        const timeDiff = endDate.getTime() - startDate.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
        document.getElementById('totalDays').value = daysDiff;
    } else {
        document.getElementById('totalDays').value = '';
    }
}

// Event listeners for date fields
document.getElementById('startDate').addEventListener('change', calculateTotalDays);
document.getElementById('endDate').addEventListener('change', calculateTotalDays);

// Submit leave application
function submitLeaveApplication(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const leaveData = {
        leaveType: document.getElementById('leaveType').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        totalDays: document.getElementById('totalDays').value,
        reason: document.getElementById('reason').value,
        contactInfo: document.getElementById('contactInfo').value,
        emergencyContact: document.getElementById('emergencyContact').value,
        workHandover: document.getElementById('workHandover').value
    };
    
    if (confirm('Are you sure you want to submit this leave request?')) {
        alert('Leave request submitted successfully! You will receive a confirmation email shortly.');
        event.target.reset();
        document.getElementById('totalDays').value = '';

    }
}

// Save draft
function saveDraft() {
    const draftData = {
        leaveType: document.getElementById('leaveType').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        reason: document.getElementById('reason').value
    };
    
    localStorage.setItem('leaveDraft', JSON.stringify(draftData));
    alert('Draft saved successfully!');
}

// Reset form
function resetForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('leaveApplicationForm').reset();
        document.getElementById('totalDays').value = '';
    }
}

// Load draft on page load
function loadDraft() {
    const draft = localStorage.getItem('leaveDraft');
    if (draft) {
        const draftData = JSON.parse(draft);
        document.getElementById('leaveType').value = draftData.leaveType || '';
        document.getElementById('startDate').value = draftData.startDate || '';
        document.getElementById('endDate').value = draftData.endDate || '';
        document.getElementById('reason').value = draftData.reason || '';
        calculateTotalDays();
    }
}



// View leave details
function viewLeaveDetails(applicationDate) {
    const record = leaveHistoryData.find(r => r.appliedOn === applicationDate);
    if (record) {
        alert(`Leave Request Details:\n\n` +
              `Applied On: ${record.appliedOn}\n` +
              `Leave Type: ${record.leaveType}\n` +
              `Start Date: ${record.startDate}\n` +
              `End Date: ${record.endDate}\n` +
              `Total Days: ${record.days}\n` +
              `Reason: ${record.reason}\n` +
              `Status: ${record.status}`);
    }
}

// Cancel leave request
function cancelLeaveRequest(applicationDate) {
    if (confirm('Are you sure you want to cancel this leave request?')) {
        const record = leaveHistoryData.find(r => r.appliedOn === applicationDate);
        if (record) {
            record.status = 'Cancelled';
            populateLeaveHistory();
            alert('Leave request cancelled successfully.');
        }
    }
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    loadDraft();
});
</script>



{% endblock %}